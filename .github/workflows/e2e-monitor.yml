name: E2E Monitor (Udemy DOM)

on:
  workflow_dispatch:
  schedule:
    # Weekly (UTC). Adjust as needed.
    - cron: "0 3 * * 1"

jobs:
  e2e-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci --no-audit --no-fund
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Install Playwright browsers (Chromium)
        run: npx playwright install --with-deps chromium

      - name: Prepare Udemy auth storage state (optional)
        if: ${{ secrets.UDEMY_E2E_STORAGE_STATE_JSON != '' }}
        run: |
          cat > .udemy-storage-state.json <<'EOF'
          ${{ secrets.UDEMY_E2E_STORAGE_STATE_JSON }}
          EOF

      - name: Run E2E monitor
        run: npm run test:e2e -- --project=chromium
        env:
          CI: "true"
          UDEMY_E2E_LECTURE_URL: ${{ vars.UDEMY_E2E_LECTURE_URL }}
          UDEMY_E2E_STORAGE_STATE: ${{ secrets.UDEMY_E2E_STORAGE_STATE_JSON != '' && '.udemy-storage-state.json' || '' }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results
