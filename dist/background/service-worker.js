"use strict";(()=>{var O={provider:"openai",apiKey:"",model:"gpt-5.1",openaiBaseUrl:"",geminiBaseUrl:"",enabled:!0,autoTranslate:!0,preloadEnabled:!0,showCostEstimate:!0,showLoadingIndicator:!0};var ie="udemy-caption-settings";function Y(){return typeof chrome<"u"&&!!chrome.storage?.sync}async function A(){return new Promise(e=>{if(Y())chrome.storage.sync.get(O,r=>{e(r)});else{let r=localStorage.getItem(ie);if(r)try{e({...O,...JSON.parse(r)})}catch{e(O)}else e(O)}})}async function it(e){return new Promise((r,t)=>{if(Y())chrome.storage.sync.set(e,()=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):r()});else try{let n=localStorage.getItem(ie),s={...n?JSON.parse(n):O,...e};localStorage.setItem(ie,JSON.stringify(s)),r()}catch(n){t(n)}})}var F=new Set;function at(e){return F.add(e),Y()&&F.size===1&&chrome.storage.onChanged.addListener(ye),()=>{F.delete(e),Y()&&F.size===0&&chrome.storage.onChanged.removeListener(ye)}}function ye(e,r){if(r!=="sync")return;let t={},n={};for(let s of Object.keys(e))s in O&&(t[s]=e[s].oldValue,n[s]=e[s].newValue);A().then(s=>{let o={...s};for(let i of Object.keys(t))t[i]!==void 0&&(o[i]=t[i]);for(let i of F)try{i(s,o)}catch(a){console.error("[SettingsManager] Error in change listener:",a)}})}function Ce(e){return!!e.apiKey&&!!e.model&&!!e.provider}function U(e){return e.enabled&&Ce(e)}var ae=class{constructor(){this.cachedSettings=null;this.unsubscribe=null}async init(){return this.cachedSettings=await A(),this.unsubscribe=at(r=>{this.cachedSettings=r}),this.cachedSettings}async getSettings(){return this.cachedSettings?this.cachedSettings:A()}async updateSettings(r){await it(r),this.cachedSettings&&(this.cachedSettings={...this.cachedSettings,...r})}isEnabled(){return this.cachedSettings?U(this.cachedSettings):!1}isConfigured(){return this.cachedSettings?Ce(this.cachedSettings):!1}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.cachedSettings=null}},br=new ae;var ct="UdemyCaptionCache";var y="subtitles";function P(){return new Promise((e,r)=>{let t=indexedDB.open(ct,1);t.onerror=()=>{r(new Error(`Failed to open database: ${t.error?.message}`))},t.onsuccess=()=>{e(t.result)},t.onupgradeneeded=n=>{let s=n.target.result;if(!s.objectStoreNames.contains(y)){let o=s.createObjectStore(y,{keyPath:"id"});o.createIndex("courseId","courseId",{unique:!1}),o.createIndex("lectureId","lectureId",{unique:!1}),o.createIndex("updatedAt","updatedAt",{unique:!1}),o.createIndex("createdAt","createdAt",{unique:!1}),o.createIndex("provider","provider",{unique:!1}),o.createIndex("model","model",{unique:!1})}}})}function X(e,r){return`${e}-${r}`}function Se(e){return JSON.stringify(e).length*2}async function ce(e,r,t){let n=await P();return new Promise((s,o)=>{let a=n.transaction(y,"readonly").objectStore(y),c=X(e,r),l=a.get(c);l.onerror=()=>{n.close(),o(new Error(`Failed to get cache entry: ${l.error?.message}`))},l.onsuccess=()=>{n.close();let u=l.result;if(!u){s({hit:!1});return}if(t!==void 0){let m=u.originalHash===t;s({hit:!0,entry:u,hashMatch:m})}else s({hit:!0,entry:u})}})}async function ut(e,r={}){let{autoEvict:t=!0}=r,n=await P(),s=Date.now(),o=X(e.courseId,e.lectureId),i=await new Promise((c,l)=>{let d=n.transaction(y,"readonly").objectStore(y).get(o);d.onerror=()=>l(new Error("Failed to check existing entry")),d.onsuccess=()=>c(d.result)}),a={id:o,courseId:e.courseId,lectureId:e.lectureId,courseName:e.courseName,lectureName:e.lectureName,originalHash:e.originalHash,translatedVTT:e.translatedVTT,provider:e.provider,model:e.model,tokensUsed:e.tokensUsed,estimatedCost:e.estimatedCost,createdAt:i?.createdAt??s,updatedAt:s};return new Promise((c,l)=>{let d=n.transaction(y,"readwrite").objectStore(y).put(a);d.onerror=()=>{n.close(),l(new Error(`Failed to set cache entry: ${d.error?.message}`))},d.onsuccess=()=>{n.close(),t&&we(r).catch(console.error),c(a)}})}async function Ee(e,r){let t=await P();return new Promise((n,s)=>{let i=t.transaction(y,"readwrite").objectStore(y),a=X(e,r),c=i.delete(a);c.onerror=()=>{t.close(),s(new Error(`Failed to delete cache entry: ${c.error?.message}`))},c.onsuccess=()=>{t.close(),n(!0)}})}async function lt(e){let r=await P();return new Promise((t,n)=>{let a=r.transaction(y,"readwrite").objectStore(y).index("courseId").openCursor(IDBKeyRange.only(e)),c=0;a.onerror=()=>{r.close(),n(new Error(`Failed to delete course cache: ${a.error?.message}`))},a.onsuccess=l=>{let u=l.target.result;u?(u.delete(),c++,u.continue()):(r.close(),t(c))}})}async function dt(){let e=await P();return new Promise((r,t)=>{let o=e.transaction(y,"readwrite").objectStore(y).clear();o.onerror=()=>{e.close(),t(new Error(`Failed to clear cache: ${o.error?.message}`))},o.onsuccess=()=>{e.close(),r()}})}async function mt(e){let r=await P();return new Promise((t,n)=>{let a=r.transaction(y,"readonly").objectStore(y).index("courseId").getAll(IDBKeyRange.only(e));a.onerror=()=>{r.close(),n(new Error(`Failed to get course entries: ${a.error?.message}`))},a.onsuccess=()=>{r.close(),t(a.result)}})}async function ke(){let e=await P();return new Promise((r,t)=>{let o=e.transaction(y,"readonly").objectStore(y).getAll();o.onerror=()=>{e.close(),t(new Error(`Failed to get all entries: ${o.error?.message}`))},o.onsuccess=()=>{e.close(),r(o.result)}})}async function gt(){let e=await P();return new Promise((r,t)=>{let o=e.transaction(y,"readonly").objectStore(y).count();o.onerror=()=>{e.close(),t(new Error(`Failed to get cache count: ${o.error?.message}`))},o.onsuccess=()=>{e.close(),r(o.result)}})}async function le(){let e=await ke();if(e.length===0)return{totalEntries:0,totalSizeBytes:0,oldestEntry:null,newestEntry:null,totalTokensUsed:0,totalEstimatedCost:0};let r=0,t=1/0,n=0,s=0,o=0;for(let i of e)r+=Se(i),t=Math.min(t,i.createdAt),n=Math.max(n,i.updatedAt),s+=i.tokensUsed,o+=i.estimatedCost;return{totalEntries:e.length,totalSizeBytes:r,oldestEntry:t===1/0?null:t,newestEntry:n===0?null:n,totalTokensUsed:s,totalEstimatedCost:o}}async function we(e={}){let{maxEntries:r=500,maxSizeBytes:t=104857600}=e,n=await le(),s=n.totalEntries>r,o=n.totalSizeBytes>t;if(!s&&!o)return 0;let i=await ke();i.sort((u,m)=>u.updatedAt-m.updatedAt);let a=0,c=n.totalSizeBytes,l=n.totalEntries;for(let u of i){let m=l<=r,d=c<=t;if(m&&d)break;await Ee(u.courseId,u.lectureId),a++,l--,c-=Se(u)}return a}async function ft(e={}){let r=await we(e),t=await le();return{evictedCount:r,remainingEntries:t.totalEntries,remainingSizeBytes:t.totalSizeBytes}}async function pt(e,r){let t=await P(),n=X(e,r);return new Promise((s,o)=>{let a=t.transaction(y,"readwrite").objectStore(y),c=a.get(n);c.onerror=()=>{t.close(),o(new Error(`Failed to touch cache entry: ${c.error?.message}`))},c.onsuccess=()=>{let l=c.result;if(!l){t.close(),s(!1);return}l.updatedAt=Date.now();let u=a.put(l);u.onerror=()=>{t.close(),o(new Error(`Failed to update cache entry: ${u.error?.message}`))},u.onsuccess=()=>{t.close(),s(!0)}}})}var ue=class{constructor(r={}){this.options={maxEntries:r.maxEntries??500,maxSizeBytes:r.maxSizeBytes??104857600,autoEvict:r.autoEvict??!0}}async get(r,t,n){let s=await ce(r,t,n);return s.hit&&await pt(r,t).catch(()=>{}),s}async set(r){return ut(r,this.options)}async delete(r,t){return Ee(r,t)}async deleteCourse(r){return lt(r)}async clear(){return dt()}async getCourseEntries(r){return mt(r)}async getStats(){return le()}async getCount(){return gt()}async has(r,t){return(await ce(r,t)).hit}async hasValid(r,t,n){let s=await ce(r,t,n);return s.hit&&s.hashMatch===!0}async cleanup(){return ft(this.options)}setOptions(r){this.options={...this.options,...r}}},N=new ue;var de="udemy-caption-plus:session-cost",me={totals:{totalTokens:0,totalCostUsd:0,updatedAt:0}},J=null;function Ie(){return typeof chrome<"u"&&!!chrome.storage?.session}function Tt(){return J||(J=structuredClone(me)),J}function ht(e){J=e}async function xe(){return Ie()?new Promise(e=>{chrome.storage.session.get({[de]:me},r=>{e(r[de]??structuredClone(me))})}):Tt()}async function Ae(e){if(!Ie()){ht(e);return}return new Promise((r,t)=>{chrome.storage.session.set({[de]:e},()=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):r()})})}async function R(e){let r=await xe(),t={...r,...e,totals:{...r.totals,...e.totals||{}}};return await Ae(t),t}async function $(e,r){let t=await xe(),n=Date.now(),s={...t,totals:{totalTokens:t.totals.totalTokens+e,totalCostUsd:t.totals.totalCostUsd+r,updatedAt:n}};return await Ae(s),s}async function Pe(e){try{if(typeof crypto>"u"||!crypto.subtle?.digest)throw new Error("crypto.subtle not available");let t=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(o=>o.toString(16).padStart(2,"0")).join("")}catch{return bt(e)}}function bt(e){let r=0;for(let t=0;t<e.length;t++){let n=e.charCodeAt(t);r=(r<<5)-r+n,r=r&r}return Math.abs(r).toString(16).padStart(8,"0")}async function Z(e){let{courseId:r,lectureId:t,originalVtt:n,force:s=!1}=e,o=n?await Pe(n):void 0,i=await N.get(r,t);return s?{decision:"retranslate",reason:"force",cacheHit:i.hit,cachedEntry:i.entry,originalHash:o}:i.hit?{decision:"use_cache",reason:"cache_valid",cacheHit:!0,cachedEntry:i.entry,originalHash:o}:{decision:"retranslate",reason:"cache_miss",cacheHit:!1,originalHash:o}}var yt="[WebVTT Parser]",Le="WEBVTT";var M={timestamp:/^(?:(\d{1,2}):)?(\d{2}):(\d{2})\.(\d{3})$/,cueTiming:/^([\d:.]+)\s*-->\s*([\d:.]+)(?:\s+(.+))?$/,styleStart:/^STYLE\s*$/,regionStart:/^REGION\s*$/,noteStart:/^NOTE\b/,bom:/^\uFEFF/},ve={debug:0,info:1,warn:2,error:3},Ct="warn";function G(e,...r){ve[e]>=ve[Ct]&&console[e==="error"?"error":e==="warn"?"warn":"log"](yt,`[${e.toUpperCase()}]`,...r)}function Re(e){let t=e.trim().match(M.timestamp);if(!t)return G("debug",`Invalid timestamp format: "${e}"`),null;let[,n,s,o,i]=t,a=n?parseInt(n,10):0,c=parseInt(s,10),l=parseInt(o,10),u=parseInt(i,10);return c>59||l>59||u>999?(G("debug",`Timestamp values out of range: "${e}"`),null):{hours:a,minutes:c,seconds:l,milliseconds:u}}function k(e){return e.hours*36e5+e.minutes*6e4+e.seconds*1e3+e.milliseconds}function St(e,r){return k(e)-k(r)}function Q(e){let r=[];if(!e||typeof e!="string")return{success:!1,error:"Empty or invalid input"};let t=e.replace(M.bom,"");t=t.replace(/\r\n/g,`
`).replace(/\r/g,`
`);let n=t.split(`
`),s=n[0]?.trim()||"";if(!s.startsWith(Le))return{success:!1,error:`Invalid WebVTT file: missing WEBVTT signature (found: "${s.substring(0,20)}")`};let o=s.substring(Le.length).trim(),a={header:o.startsWith("-")||o.startsWith(" ")?o.substring(1).trim():o||void 0,cues:[],styles:[],regions:[],notes:[]},c=1,l=0;for(;c<n.length&&n[c].trim()==="";)c++;for(;c<n.length;){let u=n[c].trim();if(u===""){c++;continue}if(M.styleStart.test(u)){let d=Et(n,c);d.style&&a.styles.push(d.style),c=d.nextIndex;continue}if(M.regionStart.test(u)){let d=kt(n,c);d.region&&a.regions.push(d.region),c=d.nextIndex;continue}if(M.noteStart.test(u)){let d=wt(n,c);d.note&&a.notes.push(d.note),c=d.nextIndex;continue}let m=It(n,c);m.cue?(a.cues.push(m.cue),l++):m.error&&r.push(`Line ${c+1}: ${m.error}`),c=m.nextIndex}return a.styles.length===0&&delete a.styles,a.regions.length===0&&delete a.regions,a.notes.length===0&&delete a.notes,G("info",`Parsed ${l} cues from WebVTT file`),{success:!0,data:a,warnings:r.length>0?r:void 0}}function Et(e,r){let t=r+1,n=[];for(;t<e.length&&e[t].trim()!=="";)n.push(e[t]),t++;return{style:n.length>0?n.join(`
`):null,nextIndex:t}}function kt(e,r){let t=r+1,n=[],s="";for(;t<e.length&&e[t].trim()!=="";){let o=e[t].trim(),i=o.match(/(?:^|\s)id:([^\s]+)/);i&&(s=i[1]),n.push(o),t++}return s?{region:{id:s,settings:n.join(`
`)},nextIndex:t}:{region:null,nextIndex:t}}function wt(e,r){let t=e[r],n=r+1,s=[],o=t.substring(4).trim();for(o&&s.push(o);n<e.length&&e[n].trim()!=="";)s.push(e[n]),n++;return{note:s.length>0?s.join(`
`):null,nextIndex:n}}function It(e,r){let t=r,n,s=e[t]?.trim()||"";if(!s.includes("-->")&&(n=s,t++,t>=e.length))return{cue:null,error:"Unexpected end of file after cue ID",nextIndex:t};let o=e[t]?.trim()||"",i=o.match(M.cueTiming);if(!i){for(;t<e.length&&e[t].trim()!=="";)t++;return{cue:null,error:`Invalid cue timing: "${o}"`,nextIndex:t}}let[,a,c,l]=i,u=Re(a),m=Re(c);if(!u||!m){for(;t<e.length&&e[t].trim()!=="";)t++;return{cue:null,error:`Invalid timestamps in: "${o}"`,nextIndex:t}}St(u,m)>=0&&G("warn",`Cue start time >= end time: ${a} --> ${c}`),t++;let d=[];for(;t<e.length&&e[t].trim()!=="";)d.push(e[t]),t++;let g=d.join(`
`);g||G("debug","Empty cue text");let p={startTime:u,endTime:m,text:g};return n&&(p.id=n),l&&(p.settings=l),{cue:p,nextIndex:t}}var xt="[WebVTT Generator]",At="WEBVTT",Oe={includeCueIds:!0,includeStyles:!0,includeRegions:!0,includeNotes:!0,useShortTimestamp:!1},Ve={debug:0,info:1,warn:2,error:3},Pt="warn";function Lt(e,...r){Ve[e]>=Ve[Pt]&&console[e==="error"?"error":e==="warn"?"warn":"log"](xt,`[${e.toUpperCase()}]`,...r)}function _e(e,r=!1){let{hours:t,minutes:n,seconds:s,milliseconds:o}=e,i=n.toString().padStart(2,"0"),a=s.toString().padStart(2,"0"),c=o.toString().padStart(3,"0");return r&&t===0?`${i}:${a}.${c}`:`${t.toString().padStart(2,"0")}:${i}:${a}.${c}`}function vt(e,r=Oe){let t=[];e.id&&r.includeCueIds!==!1&&t.push(e.id);let n=_e(e.startTime,r.useShortTimestamp),s=_e(e.endTime,r.useShortTimestamp),o=`${n} --> ${s}`;return e.settings&&(o+=` ${e.settings}`),t.push(o),e.text&&t.push(e.text),t.join(`
`)}function ee(e,r={}){let t={...Oe,...r},n=[],s=At;if(e.header&&(s+=` ${e.header}`),n.push(s),n.push(""),t.includeStyles&&e.styles&&e.styles.length>0)for(let o of e.styles)n.push("STYLE"),n.push(o),n.push("");if(t.includeRegions&&e.regions&&e.regions.length>0)for(let o of e.regions)n.push("REGION"),n.push(o.settings),n.push("");if(t.includeNotes&&e.notes&&e.notes.length>0)for(let o of e.notes)n.push(`NOTE ${o}`),n.push("");for(let o=0;o<e.cues.length;o++){let i=e.cues[o];n.push(vt(i,t)),o<e.cues.length-1&&n.push("")}return Lt("info",`Generated WebVTT with ${e.cues.length} cues`),n.join(`
`)}function Ue(e){if(e.length===0)return{cues:[]};let r={header:e[0].header,cues:[],styles:[],regions:[],notes:[]};for(let t of e)r.cues.push(...t.cues),t.styles&&r.styles.push(...t.styles),t.regions&&r.regions.push(...t.regions),t.notes&&r.notes.push(...t.notes);return r.cues.sort((t,n)=>{let s=t.startTime.hours*36e5+t.startTime.minutes*6e4+t.startTime.seconds*1e3+t.startTime.milliseconds,o=n.startTime.hours*36e5+n.startTime.minutes*6e4+n.startTime.seconds*1e3+n.startTime.milliseconds;return s-o}),r.styles.length===0&&delete r.styles,r.regions.length===0&&delete r.regions,r.notes.length===0&&delete r.notes,r}var Rt={"gpt-5.2":.01,"gpt-5.1":.008,"gpt-5-pro":.015,"gpt-5":.006,"gemini-3-pro-preview":.005,"gemini-3-flash-preview":.001,"gemini-2.5-pro":.003,"gemini-2.5-flash":5e-4};function Vt(e){return Rt[e]??.005}function te(e,r){let t=Vt(e);return r/1e3*t}var _t="[OpenAI Client]",Ot="https://api.openai.com/v1";var Ne={debug:0,info:1,warn:2,error:3},Ut="info";function w(e,...r){Ne[e]>=Ne[Ut]&&console[e==="error"?"error":e==="warn"?"warn":"log"](_t,`[${e.toUpperCase()}]`,...r)}var K=null;function Nt(){K||(K=setInterval(()=>{typeof chrome<"u"&&chrome.runtime?.getPlatformInfo&&chrome.runtime.getPlatformInfo(()=>{w("debug","Keepalive ping")})},25e3),w("debug","Keepalive timer started"))}function $t(){K&&(clearInterval(K),K=null,w("debug","Keepalive timer stopped"))}async function $e(e){let{apiKey:r,model:t,messages:n,baseUrl:s,maxTokens:o,timeout:i=6e4,stream:a=!0,signal:c}=e,l=s?.trim()||Ot;if(!r)return{success:!1,error:"API key is required",errorCode:"MISSING_API_KEY"};if(!t)return{success:!1,error:"Model is required",errorCode:"MISSING_MODEL"};if(!n||n.length===0)return{success:!1,error:"Messages are required",errorCode:"MISSING_MESSAGES"};let u={model:t,messages:n,stream:a,stream_options:a?{include_usage:!0}:void 0};o&&(u.max_tokens=o);let m=new AbortController,d=setTimeout(()=>m.abort(),i);c&&c.addEventListener("abort",()=>m.abort(),{once:!0}),Nt();try{w("info",`Calling OpenAI API with model: ${t}, baseUrl: ${l}`);let g=await fetch(`${l}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(u),signal:m.signal});if(!g.ok){let h=await g.text(),f=`HTTP ${g.status}: ${g.statusText}`,T=`HTTP_${g.status}`;try{let C=JSON.parse(h);C.error?.message&&(f=C.error.message,T=C.error.code||T)}catch{}return w("error","API error:",f),g.status===401?(f="Invalid API key. Please check your OpenAI API key.",T="INVALID_API_KEY"):g.status===429?(f="Rate limit exceeded. Please try again later.",T="RATE_LIMIT"):(g.status===500||g.status===503)&&(f="OpenAI service is temporarily unavailable. Please try again.",T="SERVICE_UNAVAILABLE"),{success:!1,error:f,errorCode:T}}if(a)return await Mt(g,t);let p=await g.json();return{success:!0,content:p.choices?.[0]?.message?.content||"",promptTokens:p.usage?.prompt_tokens,completionTokens:p.usage?.completion_tokens,totalTokens:p.usage?.total_tokens,model:p.model,finishReason:p.choices?.[0]?.finish_reason}}catch(g){return g instanceof Error?g.name==="AbortError"?(w("warn","Request aborted or timed out"),{success:!1,error:"Request timed out or was cancelled",errorCode:"TIMEOUT"}):(w("error","Request failed:",g.message),{success:!1,error:g.message,errorCode:"NETWORK_ERROR"}):{success:!1,error:"Unknown error occurred",errorCode:"UNKNOWN_ERROR"}}finally{clearTimeout(d),$t()}}async function Mt(e,r){let t=e.body?.getReader();if(!t)return{success:!1,error:"No response body",errorCode:"NO_RESPONSE_BODY"};let n=new TextDecoder,s="",o,i,a,c=r,l;try{let u="";for(;;){let{done:m,value:d}=await t.read();if(m)break;u+=n.decode(d,{stream:!0});let g=u.split(`
`);u=g.pop()||"";for(let p of g){let h=p.trim();if(!(!h||h==="data: [DONE]")&&h.startsWith("data: ")){let f=h.slice(6);try{let T=JSON.parse(f),C=T.choices?.[0]?.delta?.content;C&&(s+=C);let b=T.choices?.[0]?.finish_reason;b&&(l=b),T.usage&&(o=T.usage.prompt_tokens,i=T.usage.completion_tokens,a=T.usage.total_tokens),T.model&&(c=T.model)}catch{w("debug","Failed to parse chunk:",f)}}}}return w("info",`Streaming complete. Received ${s.length} characters`),{success:!0,content:s,promptTokens:o,completionTokens:i,totalTokens:a,model:c,finishReason:l}}catch(u){if(u instanceof Error&&u.name==="AbortError")return w("warn","Streaming aborted or timed out"),{success:!1,error:"Request timed out or was cancelled",errorCode:"TIMEOUT"};let m=u instanceof Error?u.message:String(u);return m.toLowerCase().includes("network error")?(w("warn","Streaming network error:",u),{success:!1,error:"Network error while streaming response (check VPN/firewall or blocking extensions)",errorCode:"NETWORK_ERROR"}):(w("warn","Streaming error:",u),{success:!1,error:m||"Streaming failed",errorCode:"STREAMING_ERROR"})}finally{t.releaseLock()}}function Me(e){let r=e.match(/[\u4e00-\u9fff\u3400-\u4dbf\u3000-\u303f]/g)?.length||0,t=e.length-r;return Math.ceil(r*1.5+t/4)}var Dt="[Gemini Client]",Bt="https://generativelanguage.googleapis.com/v1beta";var De={debug:0,info:1,warn:2,error:3},Ft="info";function x(e,...r){De[e]>=De[Ft]&&console[e==="error"?"error":e==="warn"?"warn":"log"](Dt,`[${e.toUpperCase()}]`,...r)}var j=null;function Gt(){j||(j=setInterval(()=>{typeof chrome<"u"&&chrome.runtime?.getPlatformInfo&&chrome.runtime.getPlatformInfo(()=>{x("debug","Keepalive ping")})},25e3),x("debug","Keepalive timer started"))}function Kt(){j&&(clearInterval(j),j=null,x("debug","Keepalive timer stopped"))}async function Be(e){let{apiKey:r,model:t,baseUrl:n,systemInstruction:s,contents:o,maxOutputTokens:i,timeout:a=6e4,stream:c=!0,signal:l}=e,u=n?.trim()||Bt;if(!r)return{success:!1,error:"API key is required",errorCode:"MISSING_API_KEY"};if(!t)return{success:!1,error:"Model is required",errorCode:"MISSING_MODEL"};if(!o||o.length===0)return{success:!1,error:"Contents are required",errorCode:"MISSING_CONTENTS"};let m={contents:o,...i&&{generationConfig:{maxOutputTokens:i}}};s&&(m.systemInstruction={parts:[{text:s}]});let d=new AbortController,g=setTimeout(()=>d.abort(),a);l&&l.addEventListener("abort",()=>d.abort()),Gt();let h=`${u}/models/${t}:${c?"streamGenerateContent":"generateContent"}?key=${r}`;try{x("info",`Calling Gemini API with model: ${t}, baseUrl: ${u}`);let f=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m),signal:d.signal});if(clearTimeout(g),!f.ok){let b=await f.text(),E=`HTTP ${f.status}: ${f.statusText}`,I=`HTTP_${f.status}`;try{let B=JSON.parse(b);B.error?.message&&(E=B.error.message,I=B.error.status||I)}catch{}return x("error","API error:",E),f.status===400?(E.includes("API_KEY_INVALID")||E.includes("API key not valid"))&&(E="Invalid API key. Please check your Gemini API key.",I="INVALID_API_KEY"):f.status===429?(E="Rate limit exceeded. Please try again later.",I="RATE_LIMIT"):(f.status===500||f.status===503)&&(E="Gemini service is temporarily unavailable. Please try again.",I="SERVICE_UNAVAILABLE"),{success:!1,error:E,errorCode:I}}if(c)return await jt(f,t);let T=await f.json();return{success:!0,content:T.candidates?.[0]?.content?.parts?.[0]?.text||"",promptTokens:T.usageMetadata?.promptTokenCount,completionTokens:T.usageMetadata?.candidatesTokenCount,totalTokens:T.usageMetadata?.totalTokenCount,model:t,finishReason:T.candidates?.[0]?.finishReason}}catch(f){return clearTimeout(g),f instanceof Error?f.name==="AbortError"?(x("warn","Request aborted or timed out"),{success:!1,error:"Request timed out or was cancelled",errorCode:"TIMEOUT"}):(x("error","Request failed:",f.message),{success:!1,error:f.message,errorCode:"NETWORK_ERROR"}):{success:!1,error:"Unknown error occurred",errorCode:"UNKNOWN_ERROR"}}finally{Kt()}}async function jt(e,r){let t=e.body?.getReader();if(!t)return{success:!1,error:"No response body",errorCode:"NO_RESPONSE_BODY"};let n=new TextDecoder,s="",o,i,a,c;try{let l="";for(;;){let{done:u,value:m}=await t.read();if(u)break;l+=n.decode(m,{stream:!0});let d=Wt(l);l=d.remaining;for(let g of d.objects)try{let p=JSON.parse(g),h=p.candidates?.[0]?.content?.parts?.[0]?.text;h&&(s+=h);let f=p.candidates?.[0]?.finishReason;f&&(c=f),p.usageMetadata&&(o=p.usageMetadata.promptTokenCount,i=p.usageMetadata.candidatesTokenCount,a=p.usageMetadata.totalTokenCount)}catch{x("debug","Failed to parse chunk:",g)}}return x("info",`Streaming complete. Received ${s.length} characters`),{success:!0,content:s,promptTokens:o,completionTokens:i,totalTokens:a,model:r,finishReason:c}}catch(l){return x("error","Streaming error:",l),{success:!1,error:l instanceof Error?l.message:"Streaming failed",errorCode:"STREAMING_ERROR"}}finally{t.releaseLock()}}function Wt(e){let r=[],t=e,n=t.split(`
`);t=n.pop()||"";for(let s of n){let o=s.trim();if(!o||o==="["||o==="]"||o===",")continue;let i=o;i.startsWith(",")&&(i=i.substring(1)),i.startsWith("[")&&(i=i.substring(1)),i.endsWith(",")&&(i=i.slice(0,-1)),i.endsWith("]")&&(i=i.slice(0,-1)),i=i.trim(),i&&i.startsWith("{")&&i.endsWith("}")&&r.push(i)}return{objects:r,remaining:t}}function Fe(e){let r=e.match(/[\u4e00-\u9fff\u3400-\u4dbf\u3000-\u303f]/g)?.length||0,t=e.length-r;return Math.ceil(r*1.5+t/4)}function Ge(e){let r,t=[];for(let n of e)if(n.role==="system")r=n.content;else{let s=n.role==="assistant"?"model":"user";t.push({role:s,parts:[{text:n.content}]})}return{systemInstruction:r,contents:t}}var qt="[Translator]",Ht=12e4,zt=2,je=600*1e3,Ke={debug:0,info:1,warn:2,error:3},Yt="info";function V(e,...r){Ke[e]>=Ke[Yt]&&console[e==="error"?"error":e==="warn"?"warn":"log"](qt,`[${e.toUpperCase()}]`,...r)}function We(e){let r=`You are an expert subtitle translator. You will receive a WebVTT subtitle file.
Translate all subtitle text from English to Chinese (\u7B80\u4F53\u4E2D\u6587).

CRITICAL RULES - YOU MUST FOLLOW THESE EXACTLY:
1. Output a COMPLETE, VALID WebVTT file
2. Start your output with "WEBVTT" header
3. Keep ALL timestamps EXACTLY as they are - do not modify any timestamp
4. Translate ONLY the text content between timestamps
5. Preserve cue IDs if present (the line before timestamps)
6. Preserve all cue settings (text after the --> timestamp)
7. Do NOT add any explanations, notes, or markdown formatting
8. Do NOT wrap the output in code blocks
9. Keep the same number of cues as the input

For technical terms commonly kept in English (API, HTTP, JavaScript, React, etc.), keep them as-is.
Use natural, fluent Chinese expressions - avoid word-for-word translation.`;if(e){let t=[];e.courseName&&t.push(`Course: "${e.courseName}"`),e.sectionName&&t.push(`Section: "${e.sectionName}"`),e.lectureName&&t.push(`Lecture: "${e.lectureName}"`),e.subject&&t.push(`Subject: ${e.subject}`),t.length>0&&(r+=`

CONTEXT (use this to improve terminology translation):
${t.join(`
`)}`)}return r}function qe(e){return`Translate this WebVTT file to Chinese (\u7B80\u4F53\u4E2D\u6587). Output ONLY the translated WebVTT file, nothing else:

${e}`}function He(e,r){if(e.cues.length===0)return[e];let t=[],n=[],s=k(e.cues[0].startTime);for(let o of e.cues){let i=k(o.endTime);n.length>0&&i-s>r&&(t.push({header:e.header,cues:n}),n=[],s=k(o.startTime)),n.push(o)}return n.length>0&&t.push({header:e.header,cues:n,styles:e.styles,regions:e.regions,notes:e.notes}),t}function Xt(e){if(e.cues.length===0)return{startMs:0,endMs:0,durationMs:0};let r=k(e.cues[0].startTime),t=k(e.cues[e.cues.length-1].endTime);return{startMs:r,endMs:t,durationMs:t-r}}function Jt(e){let r=e.trim();if(r.startsWith("```")&&(r=r.replace(/^```(?:vtt|webvtt)?\s*\n?/i,"").replace(/\n?```\s*$/,"")),!r.startsWith("WEBVTT")){let n=r.indexOf("WEBVTT");if(n!==-1)r=r.substring(n);else return{success:!1,error:"Response does not contain valid WEBVTT header"}}let t=Q(r);return!t.success||!t.data?{success:!1,error:t.error||"Failed to parse VTT response"}:{success:!0,vttFile:t.data}}function Zt(e,r){let t=[];e.cues.length!==r.cues.length&&t.push(`Cue count mismatch: expected ${e.cues.length}, got ${r.cues.length}`);let n=Math.min(e.cues.length,r.cues.length);for(let s=0;s<n;s++){let o=e.cues[s],i=r.cues[s],a=k(o.startTime),c=k(o.endTime),l=k(i.startTime),u=k(i.endTime);if((a!==l||c!==u)&&(t.push(`Timestamp mismatch at cue ${s+1}: expected ${a}-${c}, got ${l}-${u}`),t.length>=5)){t.push("(more timestamp errors omitted)");break}}return{valid:t.length===0,errors:t}}async function W(e,r){let t=Date.now(),{provider:n,apiKey:s,model:o,baseUrl:i,courseContext:a,timeout:c=Ht,maxRetries:l=zt,maxBatchDurationMs:u=je,signal:m,onProgress:d}=r,g=L=>{if(d)try{d(L)}catch(_){V("warn","onProgress callback error:",_)}},p=Q(e);if(!p.success||!p.data)return{success:!1,error:p.error||"Failed to parse VTT content",errorCode:"PARSE_ERROR"};let h=p.data,f=h.cues.length;if(f===0)return{success:!1,error:"No subtitle cues found in VTT content",errorCode:"EMPTY_CONTENT"};let T=He(h,u),C=T.length;V("info",`Translating ${f} cues in ${C} batch(es) using ${n}/${o}`),g(0);let b=[],E=0,I=0,B=We(a);for(let L=0;L<T.length;L++){if(m?.aborted)return{success:!1,error:"Translation cancelled",errorCode:"CANCELLED"};let _=T[L],nt=ee(_),st=Xt(_);V("info",`Processing batch ${L+1}/${C} (${_.cues.length} cues, ${Math.round(st.durationMs/1e3)}s)`);let v=await Qt(_,nt,B,n,s,o,c,l,m,i);if(!v.success||!v.vttFile)return{success:!1,error:v.error||`Batch ${L+1} translation failed`,errorCode:v.errorCode||"BATCH_FAILED",durationMs:Date.now()-t};b.push(v.vttFile),E+=v.promptTokens||0,I+=v.completionTokens||0;let ot=Math.round((L+1)/C*100);g(ot)}let Te=Ue(b),rt=ee(Te),oe=E+I,he=te(o,oe),be=Date.now()-t;return V("info",`Translation complete in ${be}ms, ${oe} tokens, $${he.toFixed(6)}`),g(100),{success:!0,translatedVTT:rt,translatedVTTFile:Te,tokensUsed:oe,promptTokens:E,completionTokens:I,estimatedCost:he,model:o,cueCount:f,batchCount:C,durationMs:be}}async function Qt(e,r,t,n,s,o,i,a,c,l){let u=qe(r),m,d;for(let g=0;g<=a;g++){if(g>0&&(V("info",`Retry attempt ${g}/${a}`),await new Promise(T=>setTimeout(T,1e3*Math.pow(2,g-1)))),c?.aborted)return{success:!1,error:"Translation cancelled",errorCode:"CANCELLED"};let p=await er(n,s,o,t,u,i,c,l);if(!p.success||!p.content){if(m=p.error,d=p.errorCode,p.errorCode==="INVALID_API_KEY"||p.errorCode==="MISSING_API_KEY")break;continue}let h=Jt(p.content);if(!h.success||!h.vttFile){m=h.error||"Failed to parse LLM response as VTT",d="PARSE_RESPONSE_ERROR",V("warn",`Parse error: ${m}`);continue}let f=Zt(e,h.vttFile);if(!f.valid){m=`Validation failed: ${f.errors.join("; ")}`,d="VALIDATION_ERROR",V("warn",`Validation error: ${m}`);continue}return{success:!0,vttFile:h.vttFile,promptTokens:p.promptTokens,completionTokens:p.completionTokens}}return{success:!1,error:m||"Translation failed after retries",errorCode:d||"TRANSLATION_FAILED"}}async function er(e,r,t,n,s,o,i,a){if(e==="openai")return $e({apiKey:r,model:t,baseUrl:a,messages:[{role:"system",content:n},{role:"user",content:s}],timeout:o,signal:i});{let{systemInstruction:c,contents:l}=Ge([{role:"system",content:n},{role:"user",content:s}]);return Be({apiKey:r,model:t,baseUrl:a,systemInstruction:c,contents:l,timeout:o,signal:i})}}function tr(e,r){return e==="openai"?Me(r):Fe(r)}function fe(e,r,t){let n=Q(e);if(!n.success||!n.data)return{cueCount:0,estimatedPromptTokens:0,estimatedOutputTokens:0,estimatedTotalTokens:0,estimatedCost:0,estimatedBatches:0};let s=n.data.cues.length,o=He(n.data,je),i=We(),a=0;for(let m of o){let d=ee(m),g=qe(d);a+=tr(r,i+g)}let c=Math.ceil(a*1.2),l=a+c,u=te(t,l);return{cueCount:s,estimatedPromptTokens:a,estimatedOutputTokens:c,estimatedTotalTokens:l,estimatedCost:u,estimatedBatches:o.length}}var ge=class{constructor(r={}){this.options=r}configure(r){this.options={...this.options,...r}}async translate(r,t){let n={...this.options,...t};return n.provider?n.apiKey?n.model?W(r,n):{success:!1,error:"Model is required",errorCode:"MISSING_MODEL"}:{success:!1,error:"API key is required",errorCode:"MISSING_API_KEY"}:{success:!1,error:"Provider is required",errorCode:"MISSING_PROVIDER"}}estimateCost(r){let t=this.options.provider||"openai",n=this.options.model||"gpt-5.1";return fe(r,t,n)}setCourseContext(r){this.options.courseContext=r}},Nr=new ge;var Je="[UdemyCaptionPlus][Preloader]",rr=["en","en-US","en-GB","en-AU"];function ze(...e){console.log(Je,...e)}function Ye(...e){console.warn(Je,...e)}function nr(e){return e instanceof DOMException&&e.name==="AbortError"}function Xe(e){return/^\d+$/.test(e)}function pe(e){let r=e.trim().replace(/_/g,"-"),[t,n,...s]=r.split("-").filter(Boolean);if(!t)return r;if(!n)return t.toLowerCase();let o=s.length>0?`-${s.join("-")}`:"";return`${t.toLowerCase()}-${n.toUpperCase()}${o}`}function Ze(e){let r=e.match(/[_-]([a-z]{2}(?:-[A-Z]{2})?)[_.]/)||e.match(/lang[=_]([a-z]{2}(?:-[A-Z]{2})?)/i)||e.match(/locale[=_]([a-z]{2}(?:[_-][A-Z]{2})?)/i);return r?.[1]?pe(r[1]):"en"}function Qe(e){try{return new URL(e).toString()}catch{return new URL(e,"https://www.udemy.com").toString()}}function sr(e){let r=new Set,t=[];for(let n of e){if(!n.url)continue;let s=Qe(n.url);r.has(s)||(r.add(s),t.push({...n,url:s}))}return t}function or(e){if(e.length===0)return null;for(let t of rr){let n=e.find(s=>s.language.toLowerCase()===t.toLowerCase());if(n)return n}let r=e.find(t=>t.language.toLowerCase().startsWith("en"));return r||e[0]||null}function S(e){return typeof e=="string"&&e.trim()!==""?e.trim():typeof e=="number"&&Number.isFinite(e)?String(e):null}function ir(e){let r=[];for(let t of e){if(!t||typeof t!="object")continue;let n=t,s=S(n.url)||S(n.download_url)||S(n.downloadUrl)||S(n.vtt_url)||S(n.vttUrl)||S(n.file)||null;if(!s||!s.includes(".vtt"))continue;let o=S(n.language)||S(n.locale)||S(n.srclang)||S(n.language_code)||S(n.lang)||null,i=o?pe(o):Ze(s),a=S(n.label)||i;r.push({url:s,language:i,label:a})}return r}function ar(e,r=2e3){let t=[],n=new Set,s=[e],o=0;for(;s.length>0&&o<r;){let i=s.shift();if(!i||typeof i!="object"||n.has(i))continue;if(n.add(i),o++,Array.isArray(i)){for(let l of i)s.push(l);continue}let a=i,c=Object.keys(a);for(let l of c){let u=a[l];if(typeof u=="string"&&u.includes(".vtt")){let m=S(a.language)||S(a.locale)||S(a.srclang)||S(a.language_code)||S(a.lang)||null,d=m?pe(m):Ze(u);t.push({url:u,language:d,label:d})}else u&&typeof u=="object"&&s.push(u)}}return t}function re(e){let r=[],t=e,n=[];Array.isArray(t?.asset?.captions)&&n.push(t.asset.captions),Array.isArray(t?.asset?.caption_tracks)&&n.push(t.asset.caption_tracks),Array.isArray(t?.captions)&&n.push(t.captions),Array.isArray(t?.results)&&n.push(t.results);for(let s of n)r.push(...ir(s));return r.push(...ar(e)),sr(r)}async function q(e,r){let t=await fetch(e,{credentials:"include",signal:r});if(!t.ok)throw new Error(`HTTP ${t.status} for ${e}`);return t.json()}async function cr(e,r){if(Xe(e))return e;try{let t=`https://www.udemy.com/api-2.0/courses/${encodeURIComponent(e)}/?fields[course]=id`,n=await q(t,r),s=S(n?.id);if(s&&Xe(s))return s}catch{}return null}async function ur(e,r,t){let n=await cr(e,t),s=[];n&&s.push(async()=>{let i=`https://www.udemy.com/api-2.0/users/me/subscribed-courses/${n}/lectures/${r}/?fields[lecture]=title,asset&fields[asset]=captions`,a=await q(i,t),c=re(a);return{lectureTitle:typeof a?.title=="string"?a.title:void 0,tracks:c}}),s.push(async()=>{let i=`https://www.udemy.com/api-2.0/lectures/${r}/?fields[lecture]=title,asset&fields[asset]=captions`,a=await q(i,t),c=re(a);return{lectureTitle:typeof a?.title=="string"?a.title:void 0,tracks:c}}),s.push(async()=>{let i=`https://www.udemy.com/api-2.0/lectures/${r}/captions/`,a=await q(i,t);return{lectureTitle:void 0,tracks:re(a)}}),n&&s.push(async()=>{let i=`https://www.udemy.com/api-2.0/courses/${n}/subscriber-curriculum-items/?page_size=1400&fields[lecture]=title,asset&fields[asset]=captions&caching_intent=True`,a=await q(i,t),l=(Array.isArray(a?.results)?a.results:[]).find(m=>m&&m._class==="lecture"&&String(m.id)===r),u=re(l);return{lectureTitle:typeof l?.title=="string"?l.title:void 0,tracks:u}});let o=null;for(let i of s)try{let a=await i();if(a.tracks.length>0)return a;o=new Error("No caption tracks found")}catch(a){o=a}throw o instanceof Error?o:new Error(String(o))}async function lr(e,r){let t=Qe(e),n=await fetch(t,{credentials:"include",signal:r});if(!n.ok)throw new Error(`Failed to fetch VTT (${n.status})`);return n.text()}async function et(e){let{courseId:r,lectureId:t,signal:n}=e;try{let s=await A();if(!U(s)||!s.preloadEnabled)return{ok:!0,status:"disabled",courseId:r,lectureId:t};let{lectureTitle:o,tracks:i}=await ur(r,t,n),a=or(i);if(!a)return{ok:!1,status:"error",courseId:r,lectureId:t,error:"No subtitle tracks available for preload"};let c=await lr(a.url,n);if(!c.trim().startsWith("WEBVTT"))return{ok:!1,status:"error",courseId:r,lectureId:t,error:"Fetched subtitle is not a valid WebVTT file"};let l=await Z({courseId:r,lectureId:t,originalVtt:c,force:!1});if(l.decision==="use_cache")return ze("Cache valid, skip preload:",`${r}-${t}`),{ok:!0,status:"cached",courseId:r,lectureId:t,originalHash:l.originalHash};ze("Preloading translation:",`${r}-${t}`);let u=s.provider==="openai"?s.openaiBaseUrl:s.geminiBaseUrl,m=await W(c,{provider:s.provider,apiKey:s.apiKey,model:s.model,baseUrl:u||void 0,courseContext:{courseName:e.courseName,sectionName:e.sectionName,lectureName:e.lectureName||o},signal:n}),d=typeof m.tokensUsed=="number"?m.tokensUsed:0,g=typeof m.estimatedCost=="number"?m.estimatedCost:0,p=Date.now(),h=`preload-${r}-${t}-${p}`;return!m.success||!m.translatedVTT?((d>0||g>0)&&(await $(d,g),await R({lastActual:{taskId:h,provider:s.provider,model:s.model,tokensUsed:d,costUsd:g,createdAt:p}})),{ok:!1,status:"error",courseId:r,lectureId:t,originalHash:l.originalHash,provider:s.provider,model:s.model,error:m.error||"Translation failed"}):((d>0||g>0)&&(await $(d,g),await R({lastActual:{taskId:h,provider:s.provider,model:s.model,tokensUsed:d,costUsd:g,createdAt:p}})),await N.set({courseId:r,lectureId:t,courseName:e.courseName||"",lectureName:e.lectureName||o||t,originalHash:l.originalHash||"",translatedVTT:m.translatedVTT,provider:s.provider,model:s.model,tokensUsed:d,estimatedCost:g}),{ok:!0,status:"translated",courseId:r,lectureId:t,originalHash:l.originalHash,provider:s.provider,model:s.model})}catch(s){return n?.aborted||nr(s)?(Ye("Preload aborted:",`${r}-${t}`),{ok:!0,status:"aborted",courseId:r,lectureId:t}):(Ye("Preload failed:",s),{ok:!1,status:"error",courseId:r,lectureId:t,error:String(s)})}}var D=new Map,H=new Map;function ne(e,r){typeof chrome>"u"||!chrome.tabs?.sendMessage||chrome.tabs.sendMessage(e,r).catch(()=>{})}function se(e){typeof chrome>"u"||!chrome.runtime?.sendMessage||chrome.runtime.sendMessage({...e,meta:{...e.meta||{},target:"popup"}}).catch(()=>{})}function tt(e,r,t){let n={taskId:r,progress:t};ne(e,{type:"TRANSLATION_PROGRESS",payload:n,meta:{target:"content"}}),se({type:"TRANSLATION_PROGRESS",payload:n})}function dr(e,r){ne(e,{type:"COST_ESTIMATE",payload:r,meta:{target:"content"}}),se({type:"COST_ESTIMATE",payload:r})}function z(e,r){ne(e,{type:"TRANSLATION_COMPLETE",payload:r,meta:{target:"content"}}),se({type:"TRANSLATION_COMPLETE",payload:r})}async function mr(e,r){let t=e.tab?.id;if(!t)return;let n=r?.taskId||`translate-${Date.now()}`,s=r?.vttContent,o=r?.courseId,i=r?.lectureId,a=r?.force===!0;if(!s||!o||!i){z(t,{taskId:n,success:!1,error:"Missing required fields"});return}let c=await A();if(!U(c)){z(t,{taskId:n,success:!1,error:"Translation is disabled or not configured"});return}let l=r?.provider||c.provider,u=r?.model||c.model,m=c.apiKey,d=await Z({courseId:o,lectureId:i,force:a});if(d.decision==="use_cache"&&d.cachedEntry?.translatedVTT){ne(t,{type:"CACHE_HIT",payload:{taskId:n,translatedVTT:d.cachedEntry.translatedVTT},meta:{target:"content"}}),se({type:"CACHE_HIT",payload:{taskId:n,provider:d.cachedEntry.provider,model:d.cachedEntry.model,tokensUsed:d.cachedEntry.tokensUsed,costUsd:d.cachedEntry.estimatedCost,fromCache:!0}});return}let g=D.get(n);g&&(g.abort(),D.delete(n));let p=new AbortController;if(D.set(n,p),c.showCostEstimate){let b=fe(s,l,u),E={taskId:n,provider:l,model:u,cueCount:b.cueCount,estimatedPromptTokens:b.estimatedPromptTokens,estimatedOutputTokens:b.estimatedOutputTokens,estimatedTotalTokens:b.estimatedTotalTokens,estimatedCostUsd:b.estimatedCost,estimatedBatches:b.estimatedBatches};dr(t,E),await R({lastEstimate:{taskId:n,provider:l,model:u,cueCount:b.cueCount,estimatedTotalTokens:b.estimatedTotalTokens,estimatedCostUsd:b.estimatedCost,createdAt:Date.now()}})}tt(t,n,0);let h=l==="openai"?c.openaiBaseUrl:c.geminiBaseUrl,f=await W(s,{provider:l,apiKey:m,model:u,baseUrl:h||void 0,courseContext:{courseName:r?.courseName,sectionName:r?.sectionName,lectureName:r?.lectureName},signal:p.signal,onProgress:b=>tt(t,n,b)});D.delete(n);let T=typeof f.tokensUsed=="number"?f.tokensUsed:0,C=typeof f.estimatedCost=="number"?f.estimatedCost:0;if(f.success&&f.translatedVTT){let b=await $(T,C);await R({lastActual:{taskId:n,provider:l,model:u,tokensUsed:T,costUsd:C,createdAt:Date.now()}}),await N.set({courseId:o,lectureId:i,courseName:r?.courseName||"",lectureName:r?.lectureName||r?.lectureId||"",originalHash:r?.originalHash||"",translatedVTT:f.translatedVTT,provider:l,model:u,tokensUsed:T,estimatedCost:C}),z(t,{taskId:n,success:!0,translatedVTT:f.translatedVTT,provider:l,model:u,tokensUsed:T,estimatedCost:C,sessionTotalTokens:b.totals.totalTokens,sessionTotalCostUsd:b.totals.totalCostUsd});return}if(T>0||C>0){let b=await $(T,C);await R({lastActual:{taskId:n,provider:l,model:u,tokensUsed:T,costUsd:C,createdAt:Date.now()}}),z(t,{taskId:n,success:!1,error:f.error||"Translation failed",provider:l,model:u,tokensUsed:T,estimatedCost:C,sessionTotalTokens:b.totals.totalTokens,sessionTotalCostUsd:b.totals.totalCostUsd});return}z(t,{taskId:n,success:!1,error:f.error||"Translation failed",tokensUsed:0,estimatedCost:0})}function gr(e){if(!e)return;let r=D.get(e);r&&(r.abort(),D.delete(e))}var fr=1e4;function pr(e,r){let t=e?.url;if(!t){r({ok:!1,error:"No URL provided"});return}let n=new AbortController,s=setTimeout(()=>n.abort(),fr);fetch(t,{method:"GET",credentials:"include",signal:n.signal}).then(o=>{if(clearTimeout(s),!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.text()}).then(o=>{r({ok:!0,content:o})}).catch(o=>{clearTimeout(s);let i=o instanceof Error?o.message:"Unknown error";if(i.includes("aborted")){r({ok:!1,error:"Request timeout"});return}r({ok:!1,error:i})})}async function Tr(e,r){let t=e.tab?.id;if(!t)return;let n=r?.courseId,s=r?.nextLectureId;if(!n||!s)return;let o=await A();if(!U(o)||!o.preloadEnabled)return;let i=H.get(t);if(i&&i.courseId===n&&i.lectureId===s)return;i&&(i.controller.abort(),H.delete(t));let a=new AbortController;H.set(t,{controller:a,courseId:n,lectureId:s});try{await et({courseId:n,lectureId:s,courseName:r?.courseName,sectionName:r?.sectionName,lectureName:r?.nextLectureTitle,signal:a.signal})}finally{H.get(t)?.controller===a&&H.delete(t)}}function hr(){typeof chrome>"u"||!chrome.runtime?.onMessage||chrome.runtime.onMessage.addListener((e,r,t)=>{if(!(!e||typeof e!="object"||typeof e.type!="string")&&e.meta?.target!=="popup"){if(e.type==="TRANSLATE_SUBTITLE")return mr(r,e.payload).then(()=>t?.({ok:!0})).catch(n=>t?.({ok:!1,error:String(n)})),!0;if(e.type==="GET_SETTINGS")return A().then(n=>t?.({ok:!0,settings:n})).catch(n=>t?.({ok:!1,error:String(n)})),!0;if(e.type==="PRELOAD_NEXT")return Tr(r,e.payload).then(()=>t?.({ok:!0})).catch(n=>t?.({ok:!1,error:String(n)})),!0;if(e.type==="CANCEL_TRANSLATION"){gr(e.payload?.taskId),t?.({ok:!0});return}if(e.type==="FETCH_VTT")return pr(e.payload,t),!0}})}hr();})();
