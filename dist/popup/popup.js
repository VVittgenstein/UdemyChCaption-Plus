"use strict";(()=>{var R={openai:[{value:"gpt-5.2",label:"GPT-5.2"},{value:"gpt-5.1",label:"GPT-5.1 (\u63A8\u8350)"},{value:"gpt-5-pro",label:"GPT-5 Pro"},{value:"gpt-5",label:"GPT-5"}],gemini:[{value:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview"},{value:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview (\u63A8\u8350)"},{value:"gemini-2.5-pro",label:"Gemini 2.5 Pro"},{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash"}]},p={provider:"openai",apiKey:"",model:"gpt-5.1",openaiBaseUrl:"",geminiBaseUrl:"",enabled:!0,autoTranslate:!0,preloadEnabled:!0,showCostEstimate:!0,showLoadingIndicator:!0},h="udemy-caption-plus:session-cost",u={totals:{totalTokens:0,totalCostUsd:0,updatedAt:0}},n,m=null,d=null,i=structuredClone(u);async function F(){return new Promise(t=>{if(typeof chrome<"u"&&chrome.storage?.sync)chrome.storage.sync.get(p,e=>{t(e)});else{let e=localStorage.getItem("udemy-caption-settings");if(e)try{t({...p,...JSON.parse(e)})}catch{t(p)}else t(p)}})}async function L(t){return new Promise((e,s)=>{if(typeof chrome<"u"&&chrome.storage?.sync)chrome.storage.sync.set(t,()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):e()});else{let o=localStorage.getItem("udemy-caption-settings"),a={...o?JSON.parse(o):p,...t};localStorage.setItem("udemy-caption-settings",JSON.stringify(a)),e()}})}function O(){return typeof chrome<"u"&&!!chrome.storage?.session}async function B(){if(O())return new Promise(e=>{chrome.storage.session.get({[h]:u},s=>{let o=s[h];e(o??structuredClone(u))})});let t=localStorage.getItem(h);if(!t)return structuredClone(u);try{return{...structuredClone(u),...JSON.parse(t)}}catch{return structuredClone(u)}}async function I(t){if(typeof chrome<"u"&&chrome.tabs)try{let e=await chrome.tabs.query({url:"*://*.udemy.com/*"});for(let s of e)s.id&&chrome.tabs.sendMessage(s.id,{type:"SETTINGS_UPDATED",payload:t}).catch(()=>{})}catch{}}function K(t){let e=t.trim();if(!e)return null;try{let s=new URL(e);return s.protocol!=="https:"&&s.protocol!=="http:"?null:`${s.protocol}//${s.hostname}/*`}catch{return null}}async function x(t){let e=K(t);return e?typeof chrome>"u"||!chrome.permissions?.contains||!chrome.permissions?.request?{ok:!0}:await new Promise(r=>{chrome.permissions.contains({origins:[e]},l=>r(!!l))})?{ok:!0}:await new Promise(r=>{chrome.permissions.request({origins:[e]},l=>r(!!l))})?{ok:!0}:{ok:!1,error:`\u672A\u6388\u6743\u8BBF\u95EE\u8BE5\u7AEF\u70B9\uFF1A${e.replace(/\/\*$/,"")}`}:{ok:!0}}async function _(t,e){let s=e?.trim()||"https://api.openai.com/v1";try{let o=await fetch(`${s}/models`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});return o.ok?{valid:!0}:o.status===401?{valid:!1,error:"API Key \u65E0\u6548\u6216\u5DF2\u8FC7\u671F"}:o.status===429?{valid:!1,error:"\u8BF7\u6C42\u8FC7\u4E8E\u9891\u7E41\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5"}:{valid:!1,error:(await o.json().catch(()=>({}))).error?.message||`\u9A8C\u8BC1\u5931\u8D25 (${o.status})`}}catch(o){return{valid:!1,error:!!e?.trim()?"\u65E0\u6CD5\u8FDE\u63A5\u5230\u81EA\u5B9A\u4E49\u7AEF\u70B9\uFF0C\u8BF7\u68C0\u67E5 URL \u662F\u5426\u6B63\u786E":o instanceof Error?o.message:"\u7F51\u7EDC\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5"}}}async function N(t,e){let s=e?.trim()||"https://generativelanguage.googleapis.com/v1beta";try{let o=await fetch(`${s}/models?key=${t}`,{method:"GET"});return o.ok?{valid:!0}:o.status===400||o.status===403?{valid:!1,error:"API Key \u65E0\u6548"}:o.status===429?{valid:!1,error:"\u8BF7\u6C42\u8FC7\u4E8E\u9891\u7E41\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5"}:{valid:!1,error:(await o.json().catch(()=>({}))).error?.message||`\u9A8C\u8BC1\u5931\u8D25 (${o.status})`}}catch(o){return{valid:!1,error:!!e?.trim()?"\u65E0\u6CD5\u8FDE\u63A5\u5230\u81EA\u5B9A\u4E49\u7AEF\u70B9\uFF0C\u8BF7\u68C0\u67E5 URL \u662F\u5426\u6B63\u786E":o instanceof Error?o.message:"\u7F51\u7EDC\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5"}}}async function G(t,e,s){if(!e.trim())return{valid:!1,error:"\u8BF7\u8F93\u5165 API Key"};let o=!!s?.trim();return t==="openai"?!o&&!e.startsWith("sk-")?{valid:!1,error:'OpenAI API Key \u5E94\u4EE5 "sk-" \u5F00\u5934'}:_(e,s):N(e,s)}function V(){return{enabled:document.getElementById("enabled"),settingsForm:document.getElementById("settings-form"),provider:document.getElementById("provider"),apiKey:document.getElementById("apiKey"),model:document.getElementById("model"),toggleApiKeyVisibility:document.getElementById("toggle-apikey-visibility"),toggleApiAdvanced:document.getElementById("toggle-api-advanced"),apiAdvancedContent:document.getElementById("api-advanced-content"),openaiBaseUrl:document.getElementById("openaiBaseUrl"),geminiBaseUrl:document.getElementById("geminiBaseUrl"),saveBtn:document.getElementById("save-btn"),retranslateBtn:document.getElementById("retranslate-btn"),statusMessage:document.getElementById("status-message"),validationResult:document.getElementById("validation-result"),costDisplay:document.getElementById("cost-display"),costEstimate:document.getElementById("cost-estimate"),costActual:document.getElementById("cost-actual"),costSession:document.getElementById("cost-session"),autoTranslate:document.getElementById("autoTranslate"),preloadEnabled:document.getElementById("preloadEnabled"),showCostEstimate:document.getElementById("showCostEstimate"),showLoadingIndicator:document.getElementById("showLoadingIndicator")}}function A(t){let e=R[t]||[];n.model.innerHTML=e.map(s=>`<option value="${s.value}">${s.label}</option>`).join("")}function c(t,e,s=!0){m&&(clearTimeout(m),m=null),n.statusMessage.textContent=t,n.statusMessage.className=`status-message ${e}`,n.statusMessage.classList.remove("hidden"),s&&(m=window.setTimeout(()=>{n.statusMessage.classList.add("hidden"),m=null},3e3))}function U(t){t?n.costDisplay.classList.remove("hidden"):n.costDisplay.classList.add("hidden")}function z(t){return!Number.isFinite(t)||t<=0?"0":t>=1e6?`${(t/1e6).toFixed(2)}M`:t>=1e4?`${(t/1e3).toFixed(1)}K`:t.toLocaleString()}function j(t){if(!Number.isFinite(t)||t<=0)return"$0";let e=Math.abs(t);return e>=10?`$${t.toFixed(2)}`:e>=1?`$${t.toFixed(3)}`:e>=.1?`$${t.toFixed(4)}`:`$${t.toFixed(6)}`}function T(t,e,s){let o=`${z(t)} tokens`,a=j(e);return`${s?"\u2248 ":""}${o} \xB7 ${s?"\u2248 ":""}${a}`}function g(){let t=i.lastEstimate,e=i.lastActual;t?n.costEstimate.textContent=T(t.estimatedTotalTokens,t.estimatedCostUsd,!0):n.costEstimate.textContent="-",e?n.costActual.textContent=T(e.tokensUsed,e.costUsd,!1):n.costActual.textContent="-",n.costSession.textContent=T(i.totals.totalTokens,i.totals.totalCostUsd,!1)}function y(t,e){n.validationResult.className=`validation-result ${t?"success":"error"}`,n.validationResult.querySelector(".validation-text").textContent=e,n.validationResult.classList.remove("hidden")}function M(){n.validationResult.classList.add("hidden")}function w(t){t?(n.saveBtn.classList.add("loading"),n.saveBtn.disabled=!0):(n.saveBtn.classList.remove("loading"),n.saveBtn.disabled=!1)}function b(t){t?(n.retranslateBtn.classList.add("loading"),n.retranslateBtn.disabled=!0):(n.retranslateBtn.classList.remove("loading"),n.retranslateBtn.disabled=!1)}function H(t){t?n.settingsForm.classList.remove("disabled"):n.settingsForm.classList.add("disabled")}function q(t){n.enabled.checked=t.enabled,n.provider.value=t.provider,A(t.provider),n.model.value=t.model,n.apiKey.value=t.apiKey,n.openaiBaseUrl.value=t.openaiBaseUrl||"",n.geminiBaseUrl.value=t.geminiBaseUrl||"",n.autoTranslate.checked=t.autoTranslate,n.preloadEnabled.checked=t.preloadEnabled,n.showCostEstimate.checked=t.showCostEstimate,n.showLoadingIndicator.checked=t.showLoadingIndicator,H(t.enabled),U(t.showCostEstimate)}function C(){return{enabled:n.enabled.checked,provider:n.provider.value,apiKey:n.apiKey.value,model:n.model.value,openaiBaseUrl:n.openaiBaseUrl.value.trim(),geminiBaseUrl:n.geminiBaseUrl.value.trim(),autoTranslate:n.autoTranslate.checked,preloadEnabled:n.preloadEnabled.checked,showCostEstimate:n.showCostEstimate.checked,showLoadingIndicator:n.showLoadingIndicator.checked}}function J(){let t=n.provider.value;A(t),M()}function W(){n.apiAdvancedContent.classList.contains("hidden")?(n.apiAdvancedContent.classList.remove("hidden"),n.toggleApiAdvanced.classList.add("expanded")):(n.apiAdvancedContent.classList.add("hidden"),n.toggleApiAdvanced.classList.remove("expanded"))}function Y(){let t=n.apiKey.type==="password";n.apiKey.type=t?"text":"password";let e=document.getElementById("eye-path");e&&(t?e.setAttribute("d","M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"):e.setAttribute("d","M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"))}async function Q(){let t=n.enabled.checked;H(t);try{await L({enabled:t});let e=C();await I(e)}catch{c("\u4FDD\u5B58\u5931\u8D25","error")}}async function E(t){let e=n[t];if(e)try{await L({[t]:e.checked});let s=C();await I(s),t==="showCostEstimate"&&(U(e.checked),e.checked&&(i=await B(),g()))}catch{c("\u4FDD\u5B58\u5931\u8D25","error")}}async function X(t){t.preventDefault(),M(),w(!0);let e=C(),s=e.provider==="openai"?e.openaiBaseUrl:e.geminiBaseUrl,o=s||(e.provider==="openai"?"https://api.openai.com/v1":"https://generativelanguage.googleapis.com/v1beta");try{let a=await x(o);if(!a.ok){y(!1,a.error||"\u672A\u6388\u6743\u8BBF\u95EE\u8BE5\u7AEF\u70B9");return}let r=await G(e.provider,e.apiKey,s);r.valid?(await L(e),await I(e),y(!0,"API Key \u9A8C\u8BC1\u6210\u529F\uFF0C\u8BBE\u7F6E\u5DF2\u4FDD\u5B58")):y(!1,r.error||"\u9A8C\u8BC1\u5931\u8D25")}catch(a){y(!1,a instanceof Error?a.message:"\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5")}finally{w(!1)}}function Z(){return`retranslate-${Date.now()}-${Math.random().toString(16).slice(2)}`}async function ee(){if(typeof chrome>"u"||!chrome.tabs?.query)return null;let e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];return!e?.id||e.url&&!/\/\/([^/]*\.)?udemy\.com\//i.test(e.url)?null:e.id}async function te(){let t=await ee();if(!t){c("\u8BF7\u5148\u6253\u5F00 Udemy \u8BFE\u7A0B\u64AD\u653E\u9875","error");return}let e=Z();d=e,b(!0),c("\u5DF2\u53D1\u8D77\u91CD\u8BD1\u8BF7\u6C42\u2026","info",!1);try{await chrome.tabs.sendMessage(t,{type:"RETRANSLATE_CURRENT",payload:{taskId:e}})}catch{d=null,b(!1),c("\u53D1\u9001\u5931\u8D25\uFF1A\u8BF7\u5237\u65B0\u8BFE\u7A0B\u9875\u540E\u91CD\u8BD5","error")}}function ne(){typeof chrome>"u"||!chrome.runtime?.onMessage||chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object")){if(t.type==="COST_ESTIMATE"){let e=t.payload;if(!e||typeof e!="object")return;let s=typeof e.taskId=="string"?e.taskId:"",o=e.provider==="gemini"?"gemini":"openai",a=typeof e.model=="string"?e.model:"",r=typeof e.cueCount=="number"?e.cueCount:0,l=typeof e.estimatedTotalTokens=="number"?e.estimatedTotalTokens:0,f=typeof e.estimatedCostUsd=="number"?e.estimatedCostUsd:0;if(!s||!a)return;i={...i,lastEstimate:{taskId:s,provider:o,model:a,cueCount:r,estimatedTotalTokens:l,estimatedCostUsd:f,createdAt:Date.now()}},n.showCostEstimate.checked&&g();return}if(t.type==="CACHE_HIT"){let e=t.payload;if(!e||typeof e!="object")return;let s=typeof e.taskId=="string"?e.taskId:"",o=e.provider==="gemini"?"gemini":"openai",a=typeof e.model=="string"?e.model:"",r=typeof e.tokensUsed=="number"?e.tokensUsed:0,l=typeof e.costUsd=="number"?e.costUsd:0;s&&a&&(r>0||l>0)&&(i={...i,lastActual:{taskId:s,provider:o,model:a,tokensUsed:r,costUsd:l,createdAt:Date.now()}},n.showCostEstimate.checked&&g());return}if(t.type==="TRANSLATION_PROGRESS"){let e=t.payload?.taskId,s=t.payload?.progress;if(!d||e!==d||typeof s!="number")return;let o=Math.max(0,Math.min(100,Math.round(s)));c(`\u91CD\u8BD1\u4E2D\u2026 ${o}%`,"info",!1);return}if(t.type==="TRANSLATION_COMPLETE"){let e=t.payload,s=e?.taskId;if(e&&typeof e=="object"){let r=typeof e.tokensUsed=="number"?e.tokensUsed:0,l=typeof e.estimatedCost=="number"?e.estimatedCost:0,f=typeof e.sessionTotalTokens=="number"?e.sessionTotalTokens:null,S=typeof e.sessionTotalCostUsd=="number"?e.sessionTotalCostUsd:null;if(typeof s=="string"){let v=i.lastEstimate?.taskId===s?i.lastEstimate:null,P=v?v.provider:"openai",$=v?v.model:n.model.value,D=e.provider==="gemini"?"gemini":e.provider==="openai"?"openai":P,k=typeof e.model=="string"?e.model:$;k&&(r>0||l>0)&&(i={...i,lastActual:{taskId:s,provider:D,model:k,tokensUsed:r,costUsd:l,createdAt:Date.now()}})}f!==null&&S!==null&&(i={...i,totals:{totalTokens:f,totalCostUsd:S,updatedAt:Date.now()}}),n.showCostEstimate.checked&&g()}if(!d||s&&s!==d)return;let o=e?.success===!0,a=e?.error;d=null,b(!1),c(o?"\u91CD\u8BD1\u5B8C\u6210":`\u91CD\u8BD1\u5931\u8D25\uFF1A${a||"\u672A\u77E5\u9519\u8BEF"}`,o?"success":"error")}}})}async function se(){n=V();let t=await F();q(t),t.showCostEstimate&&(i=await B(),g()),n.provider.addEventListener("change",J),n.toggleApiKeyVisibility.addEventListener("click",Y),n.toggleApiAdvanced.addEventListener("click",W),n.enabled.addEventListener("change",Q),n.settingsForm.addEventListener("submit",X),n.autoTranslate.addEventListener("change",()=>E("autoTranslate")),n.preloadEnabled.addEventListener("change",()=>E("preloadEnabled")),n.showCostEstimate.addEventListener("change",()=>E("showCostEstimate")),n.showLoadingIndicator.addEventListener("change",()=>E("showLoadingIndicator")),n.retranslateBtn.addEventListener("click",te),ne(),n.apiKey.addEventListener("input",M)}document.addEventListener("DOMContentLoaded",se);})();
