# Compact: T-20251223-act-011-build-preload

**Generated**: 2025-12-24T00:05:26Z  
**Task**: 实现预加载模块（后台翻译下一课字幕） (FR-06)  
**Status**: completed  
**Owner**: codex-cli  

---

## 1. 范围对齐

| 维度 | 内容 |
|------|------|
| Subtask ID | T-20251223-act-011-build-preload |
| 标题 | 实现预加载模块（后台翻译下一课字幕） |
| Summary | 当前课播放/观看期间后台静默翻译下一课字幕并缓存，提升连续观看体验 |
| 依赖 | T-20251223-act-002-spike-next-lecture；T-20251223-act-007-build-llm-translator；T-20251223-act-010-build-local-cache |
| 验收标准 | 自动识别下一课 ID；后台抓取/翻译下一课字幕；写入本地缓存；跳转时命中缓存；快速跳转可中断不必要请求 |
| 产出文件 | `src/services/preloader.ts`，`src/content/next-lecture-detector.ts`，`src/background/service-worker.ts`，`src/content/content-script.ts`，`src/types/index.ts` |

---

## 2. 已确认事实（代码 + 自测覆盖）

### 2.1 下一课 ID 检测（Content Script）

- 已实现 `detectNextLecture()`：优先调用 Curriculum API 拉取课程结构，过滤 `lecture` 并按 `object_index/sort_order` 排序，输出 `nextLectureId/nextLectureTitle/isLastLecture`，并标注 `method=curriculum-api/none`。(src/content/next-lecture-detector.ts)
- 当 Curriculum API 失败/不可用时，尝试从 `window.UD` 多个路径读取下一课 ID，返回 `method=ud-fallback`。(src/content/next-lecture-detector.ts)
- 单测覆盖：API 成功、当前为最后一课、API 失败→UD fallback。(src/content/__tests__/next-lecture-detector.test.ts)

### 2.2 后台预加载流水线（Service Worker）

- 已实现 `preloadLecture()`：在 `enabled && configured && preloadEnabled` 时执行「抓取下一课 WebVTT → `checkSubtitleVersion(originalVtt)` →（cache valid 则跳过）→ `translateVTT()` → `subtitleCache.set()` 写入 IndexedDB」。(src/services/preloader.ts)
- 预加载翻译同样会更新会话费用统计：将 `translateVTT()` 返回的 `tokensUsed/estimatedCost` 计入 `addSessionCost()`，并写入 `updateSessionCostState({ lastActual })`，避免预加载绕过成本统计/预算。(src/services/preloader.ts, src/storage/session-cost.ts)
- 字幕抓取支持多 endpoint 兜底（按顺序尝试）：`/users/me/subscribed-courses/{courseId}/lectures/{lectureId}` → `/lectures/{lectureId}` → `/lectures/{lectureId}/captions/` →（可选）`/courses/{courseId}/subscriber-curriculum-items` 扩展 fields 拉取 captions。(src/services/preloader.ts)
- 单测覆盖：首次预加载会写入 cache 且计入 session cost；同一 courseId/lectureId 再次调用时命中 cache 并跳过 `translateVTT()`（不重复计费）。(src/services/__tests__/preloader.test.ts)

### 2.3 自测结果

- `npm test`：10 suites / 290 tests 通过 ✅
- `npm run type-check`：通过 ✅
- `npm run build`：通过 ✅

---

## 3. 接口 & 行为变更（对下游影响）

### 3.1 新增公共 API

```ts
// src/services/preloader.ts
preloadLecture(request: PreloadRequest): Promise<PreloadResult>

// src/content/next-lecture-detector.ts
detectNextLecture(params: NextLectureDetectionParams): Promise<NextLectureDetectionResult>
```

### 3.2 消息协议变更（types）

- `MessageToBackground.PRELOAD_NEXT` payload 扩展：新增可选 `nextLectureTitle/courseName/sectionName`；Service Worker 新增 `PRELOAD_NEXT` handler，并按 tab 维度中断旧预加载。(src/types/index.ts, src/background/service-worker.ts)
- Content Script 新增预加载触发：向后台发送 `PRELOAD_NEXT`，并在 SPA lectureId 变化时重触发。(src/content/content-script.ts)

---

## 4. 关键实现要点（事实快照）

- 触发时机：Content Script 在初始化时调用 `requestPreloadNextLecture()`；并通过 1s 轮询 URL 的 lectureId 变化来识别 SPA 路由切换后再次触发（同时清空去重 key）。(src/content/content-script.ts)
- 去重与中断：同一 Tab 的 `PRELOAD_NEXT` 新请求会 `abort` 上一个预加载 controller；Content Script 侧通过 `lastPreloadKey=courseId-nextLectureId` 避免重复发送。(src/background/service-worker.ts, src/content/content-script.ts)

---

## 5. 显式限制 / 风险 / 未完成 TODO（仅陈述已知边界）

- 预加载字幕抓取依赖 Udemy 私有 API/响应结构；当前仅有 mock 单测，未在真实 Udemy 环境中验证（可能受登录状态、权限、API 变更影响）。(src/services/preloader.ts)
- Service Worker 侧对 `https://www.udemy.com/*` 的跨域 `fetch(credentials: 'include')` 依赖 Manifest host permissions 等装配；仓库目前未包含 manifest 配置细节，需在打包/上架前确认权限，否则预加载链路可能失败。(repo-level)
- Content Script 的 SPA 变更检测为轮询方案（1s interval），未覆盖更复杂导航场景与性能影响评估。(src/content/content-script.ts)
- 预加载过程“静默”执行：未向 Popup/页面显式暴露 preload 成功/失败状态与进度（除 console）。(src/background/service-worker.ts, src/services/preloader.ts)

---

## Code Review Fix - 2025-12-24T00:20:26Z

- [P1] 修复预加载翻译绕过 session cost 统计：`preloadLecture()` 现在会与正常翻译入口一致，累计 tokens/USD 并写入 lastActual（同时补齐单测断言）。(src/services/preloader.ts, src/services/__tests__/preloader.test.ts)
