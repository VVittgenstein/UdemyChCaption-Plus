{
  "test_config": {
    "primary_test_course": {
      "name": "2D RPG with Alex Dev",
      "course_url": "https://www.udemy.com/course/2d-rpg-alexdev/",
      "slug": "2d-rpg-alexdev",
      "test_lecture": {
        "url": "https://www.udemy.com/course/2d-rpg-alexdev/learn/lecture/36963178#content",
        "lecture_id": "36963178",
        "note": "用于 Spike 验证的具体课时页面"
      },
      "note": "首选测试课程，用于验证字幕抓取、翻译和注入功能"
    }
  },
  "project_context": {
    "brief": "Chrome 扩展，为 Udemy 视频提供 LLM 驱动的高质量中文字幕替换，解决机翻断句割裂问题，通过本地缓存和预加载实现流畅体验。",
    "mvp_goal": "用户配置 API Key 后，自动抓取 Udemy 课程字幕并调用 LLM 翻译，以原生 <track> 元素注入播放器，支持本地缓存避免重复翻译。",
    "non_goals": [
      "不涉及视频内容修改或下载",
      "不自建翻译模型服务（依赖第三方 API）",
      "暂不支持无任何原文字幕的视频（不实现 ASR）",
      "不提供云端字幕同步或共享功能",
      "术语库上传功能属未来规划，MVP 不含"
    ]
  },
  "md_source": "read_only.md",
  "generated_at": "2025-12-23T12:00:00Z",
  "tasks": {
    "_execution_order_note": "任务按拓扑排序排列：先无依赖任务，再按依赖层级递进。同层任务可并行执行。",
    "T-20251223-act-001-spike-track-inject": {
      "execution_order": 1,
      "execution_layer": 1,
      "parallel_with": [
        "ACT-002",
        "ACT-003"
      ],
      "seed_id": "ACT-001",
      "title": "Spike: 验证 Udemy 播放器 <track> 动态注入可行性",
      "type": "research",
      "summary": "确认技术路径 A 可行，解锁后续字幕注入开发；验证 CSP 绕过方案（data URI / chrome.runtime.getURL）在当前 Udemy + Chrome 环境有效。此为最高优先级阻断性验证。",
      "acceptance_draft": [
        "在 Udemy 课程页控制台执行注入脚本",
        "播放器字幕菜单出现新添加的轨道选项",
        "选中新轨道后字幕能正常随视频时间轴显示",
        "全屏模式下字幕样式与原生一致",
        "记录有效的 CSP 绕过方式（data URI 或 runtime.getURL）"
      ],
      "lane": "now",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "Spike 验证完成！Data URI、Blob URL、addTextTrack API 三种方案均可行。实测字幕注入成功，时间同步正常，无 CSP 拦截。推荐 Data URI 作为首选方案。",
      "dependencies": [],
      "blocked": false,
      "blocked_by": [
        {
          "dep_id": "DEP-003",
          "name": "Udemy Web 前端 (Video.js)",
          "type": "access",
          "status": "verified",
          "doc_url": "",
          "note": "已验证：Udemy 允许动态添加 <track> 元素，无 CSP 阻止"
        }
      ],
      "unblock_plan": "实际在 Udemy 课程页执行注入代码验证，记录 DOM 结构和可行方案",
      "estimate_h": 4,
      "interfaces_touched": [
        "content-script",
        "video-player-dom"
      ],
      "artifacts": [
        "spike-report-track-inject.md",
        "Compact/Compact-T-20251223-act-001-spike-track-inject-2025-12-23-T131857Z.md"
      ],
      "citations": [
        "EVID-006",
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T15:30:00Z",
      "completed_at": "2025-12-23T15:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-001",
        "spike",
        "blocking",
        "mvp-critical"
      ],
      "completion_summary": {
        "deliverables": ["spike-report-track-inject.md"],
        "key_findings": [
          "Data URI 方案实测可行，字幕正常显示，时间同步正确",
          "Blob URL 方案可行，轨道成功创建",
          "addTextTrack API 可行，无需外部 URL",
          "无 CSP 拦截，三种方案均可用",
          "Track count 从 0 增加到 3，字幕菜单成功更新"
        ],
        "recommended_approach": "Data URI (base64 编码 VTT 内容) - 已验证",
        "verification_date": "2025-12-23T13:05:33.956Z",
        "verified_on_url": "https://www.udemy.com/course/2d-rpg-alexdev/learn/lecture/36963178",
        "next_steps": ["推进 track-injector 模块开发 (ACT-008)", "验证全屏模式字幕样式"]
      }
    },
    "T-20251223-act-002-spike-next-lecture": {
      "execution_order": 2,
      "execution_layer": 1,
      "parallel_with": [
        "ACT-001",
        "ACT-003"
      ],
      "seed_id": "ACT-002",
      "title": "Spike: 分析 Udemy 页面课程列表结构，确定下一课 ID 获取方式",
      "type": "research",
      "summary": "预加载功能依赖准确获取下一课标识，需逆向分析 Udemy 页面 DOM 或数据结构以确定获取方式。",
      "acceptance_draft": [
        "文档记录获取下一课 ID 的方式（DOM 选择器或页面内嵌数据）",
        "提供示例代码片段可稳定提取下一课 ID",
        "记录边界情况处理（最后一课、跨章节等）"
      ],
      "lane": "now",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "Spike 验证完成！Curriculum API 方案可行，成功获取 224 个课程项并正确识别下一课。推荐使用 subscriber-curriculum-items API。",
      "dependencies": [],
      "blocked": false,
      "blocked_by": [
        {
          "dep_id": "DEP-003",
          "name": "Udemy Web 前端 (Video.js)",
          "type": "access",
          "status": "verified",
          "doc_url": "",
          "note": "已验证 (2025-12-23): Curriculum API 可用，返回完整课程结构"
        }
      ],
      "unblock_plan": "在 Udemy 课程页 DevTools 中分析 DOM 结构和 window 对象数据",
      "estimate_h": 3,
      "interfaces_touched": [
        "content-script",
        "udemy-page-structure",
        "udemy-curriculum-api"
      ],
      "artifacts": [
        "spike-report-next-lecture.md",
        "Compact/Compact-T-20251223-act-002-spike-next-lecture.md"
      ],
      "citations": [
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T16:30:00Z",
      "completed_at": "2025-12-23T16:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-002",
        "spike",
        "preload"
      ],
      "completion_summary": {
        "deliverables": ["spike-report-next-lecture.md"],
        "key_findings": [
          "Curriculum API 完全可行: api-2.0/courses/{id}/subscriber-curriculum-items/",
          "API 返回完整课程结构 (224 项)，包含 lecture/chapter/quiz/practice",
          "DOM 方案受限: Udemy 使用 React + onClick，无传统 <a> 标签",
          "侧边栏懒加载，只渲染当前章节项目",
          "go-to-next 按钮存在但无直接 href"
        ],
        "recommended_approach": "Curriculum API (subscriber-curriculum-items)",
        "api_endpoint": "https://www.udemy.com/api-2.0/courses/{courseId}/subscriber-curriculum-items/",
        "verification_date": "2025-12-23T16:30:00Z",
        "verified_on_url": "https://www.udemy.com/course/2d-rpg-alexdev/learn/lecture/36963178",
        "test_course_id": "5059176",
        "next_steps": ["集成到预加载模块 (ACT-011)", "添加缓存机制", "建立 API 变化监控"]
      }
    },
    "T-20251223-act-003-spike-mv3-sw-lifecycle": {
      "execution_order": 3,
      "execution_layer": 1,
      "parallel_with": [
        "ACT-001",
        "ACT-002"
      ],
      "seed_id": "ACT-003",
      "title": "Spike: 验证 Manifest V3 Service Worker 生命周期对长时翻译任务影响",
      "type": "research",
      "summary": "LLM 翻译可能需要 30-60 秒，需确保 Service Worker 不被 Chrome 提前终止。此为架构设计的前置条件。",
      "acceptance_draft": [
        "文档记录 MV3 Service Worker 休眠机制和超时时间",
        "验证 60 秒翻译任务是否可在 SW 中完成",
        "记录可行的 SW 保活方案（chrome.alarms / 长连接 / offscreen document 等）",
        "提供示例代码验证保活方案有效"
      ],
      "lane": "now",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "Spike 验证完成！MV3 SW 生命周期限制可通过流式 API + Chrome API 保活解决。推荐使用 Streaming API，配合 setInterval 调用 chrome.runtime.getPlatformInfo 保活。",
      "dependencies": [],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "service-worker",
        "manifest-v3"
      ],
      "artifacts": [
        "spike-report-sw-lifecycle.md"
      ],
      "citations": [
        "EVID-011"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T18:30:00Z",
      "completed_at": "2025-12-23T18:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-003",
        "spike",
        "architecture",
        "mv3"
      ],
      "completion_summary": {
        "deliverables": ["spike-report-sw-lifecycle.md"],
        "key_findings": [
          "30秒不活动超时：可通过 Chrome API 调用重置 (Chrome 110+)",
          "5分钟单次请求超时：不影响60秒翻译任务",
          "fetch() 30秒响应超时：使用流式 API 可避免",
          "4种保活方案已验证：流式API、Chrome API保活、Offscreen Document、长连接消息端口",
          "推荐最低 Chrome 版本：110+"
        ],
        "recommended_approach": "流式 API (Streaming) + Chrome API 保活 (setInterval + chrome.runtime.getPlatformInfo)",
        "verification_date": "2025-12-23T18:30:00Z",
        "minimum_chrome_version": "110",
        "next_steps": ["集成到架构设计 (ACT-004)", "实现 LLM 翻译模块 (ACT-007) 时采用流式 API"]
      }
    },
    "T-20251223-act-004-design-architecture": {
      "execution_order": 4,
      "execution_layer": 2,
      "parallel_with": [],
      "seed_id": "ACT-004",
      "title": "设计扩展架构（Content Script / Service Worker / Popup 分工）",
      "type": "design",
      "summary": "Manifest V3 约束下明确各模块职责，避免 SW 生命周期问题。需在 Spike 结论基础上设计稳定可维护的架构。",
      "acceptance_draft": [
        "产出架构图（Content Script / SW / Popup / Storage 交互）",
        "模块职责文档明确各组件边界",
        "API 调用流程图（从字幕抓取到注入）",
        "评审通过，团队理解一致"
      ],
      "lane": "now",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "架构设计已完成并通过评审。包含整体架构图、模块职责定义、API 调用流程图、技术决策记录。基于 3 个 Spike 验证结果设计，采用 Data URI 注入 + 流式 API + Chrome API 保活方案。✅ 评审通过，已进行多次修改。",
      "dependencies": [
        "T-20251223-act-001-spike-track-inject",
        "T-20251223-act-003-spike-mv3-sw-lifecycle"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "content-script",
        "service-worker",
        "popup",
        "storage"
      ],
      "artifacts": [
        "architecture.md",
        "architecture-diagram.png",
        "Compact/Compact-T-20251223-act-004-design-architecture-2025-12-23-T193500Z.md"
      ],
      "citations": [
        "EVID-011"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T20:30:00Z",
      "completed_at": "2025-12-23T20:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-004",
        "design",
        "architecture",
        "mvp-critical"
      ],
      "completion_summary": {
        "deliverables": ["architecture.md", "architecture-diagram.png"],
        "key_contents": [
          "整体架构图 (ASCII): Content Script / Service Worker / Popup / Storage 四层架构",
          "模块职责定义: 14 个模块的接口定义和职责边界",
          "核心流程图: 字幕翻译主流程、预加载流程",
          "消息协议: Content Script ↔ Service Worker ↔ Popup 通信协议",
          "技术决策: Data URI 注入、流式 API、Curriculum API、Chrome 110+ 最低版本"
        ],
        "design_decisions": [
          "字幕注入: Data URI 方式 (验证自 ACT-001)",
          "LLM 调用: 流式 API + Chrome API 保活 (验证自 ACT-003)",
          "下一课 ID: Curriculum API (验证自 ACT-002)",
          "最低 Chrome 版本: 110+"
        ],
        "directory_structure": "src/{background,content,popup,storage,utils,types}/",
        "next_unblocked_tasks": ["ACT-005", "ACT-006", "ACT-009", "ACT-010"]
      }
    },
    "T-20251223-act-005-build-subtitle-fetch": {
      "execution_order": 5,
      "execution_layer": 3,
      "parallel_with": [
        "ACT-006",
        "ACT-009",
        "ACT-010"
      ],
      "seed_id": "ACT-005",
      "title": "实现字幕抓取模块（Content Script）",
      "type": "build",
      "summary": "FR-01 核心功能，在 Content Script 中检测 Udemy 视频页面并获取原始字幕 URL，下载 WebVTT 内容。",
      "acceptance_draft": [
        "Content Script 在 Udemy 课程播放页加载后 3 秒内识别视频元素",
        "成功提取原始字幕 URL（优先英文 WebVTT）",
        "单元测试覆盖字幕 URL 提取逻辑",
        "集成测试在真实 Udemy 页面抓取成功",
        "控制台/日志可见字幕抓取状态"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "字幕抓取模块实现完成！包含视频检测、字幕轨道提取、VTT 内容下载、语言优先级选择等核心功能。提供函数式和类式两种 API。单元测试覆盖主要功能。",
      "dependencies": [
        "T-20251223-act-001-spike-track-inject",
        "T-20251223-act-004-design-architecture"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 6,
      "interfaces_touched": [
        "content-script",
        "udemy-video-player"
      ],
      "artifacts": [
        "src/content/subtitle-fetcher.ts",
        "src/content/__tests__/subtitle-fetcher.test.ts",
        "src/types/index.ts",
        "package.json",
        "tsconfig.json",
        "jest.config.js",
        "Compact/Compact-T-20251223-act-005-build-subtitle-fetch-2025-12-24-T003500Z.md"
      ],
      "citations": [
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T01:15:00Z",
      "completed_at": "2025-12-24T00:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-005",
        "build",
        "core",
        "FR-01"
      ],
      "code_review": {
        "status": "passed",
        "reviewed_at": "2025-12-24T01:15:00Z",
        "findings_resolved": 3,
        "fixes": [
          "isValidVTT: 添加 BOM (U+FEFF) 前缀剥离，修复 BOM-prefixed VTT 文件被拒绝的问题",
          "jest.config.js: 移除 useESM: true，项目为 CommonJS，ts-jest 现在正确输出 CJS 模块",
          "getSubtitleTracks: TextTrack API 分支现在检查 URL 是否有效，若所有轨道 URL 为空则继续尝试 network-intercept 方法"
        ]
      },
      "completion_summary": {
        "deliverables": [
          "src/content/subtitle-fetcher.ts - 主模块 (400+ 行)",
          "src/types/index.ts - 类型定义",
          "src/content/__tests__/subtitle-fetcher.test.ts - 单元测试",
          "package.json, tsconfig.json, jest.config.js - 项目配置"
        ],
        "key_features": [
          "视频检测: 3秒超时轮询，多选择器支持",
          "课程信息提取: URL 解析 + Performance API + UD 对象",
          "字幕轨道提取: DOM <track>、TextTrack API、网络拦截三种方式",
          "VTT 下载: 带超时的 fetch，格式校验 (支持 BOM 前缀)，SHA-256 哈希",
          "语言优先级: en > en-US > en-GB > 其他英语 > 默认 > 首个",
          "日志系统: 可配置级别的控制台输出"
        ],
        "api_exports": [
          "fetchSubtitles() - 一键获取字幕的主入口",
          "detectVideo() - 检测视频元素",
          "getSubtitleTracks() - 获取字幕轨道列表",
          "fetchVTT() - 下载 VTT 内容",
          "selectPreferredTrack() - 选择首选轨道",
          "SubtitleFetcher class - 面向对象接口"
        ],
        "test_coverage": [
          "课程信息提取测试",
          "轨道选择逻辑测试",
          "VTT 获取和校验测试",
          "边界情况测试"
        ],
        "next_steps": [
          "集成测试在真实 Udemy 页面验证 (需浏览器环境)",
          "与 track-injector 模块集成 (ACT-008)",
          "与消息桥接模块配合 (发送字幕到 Service Worker)"
        ]
      }
    },
    "T-20251223-act-006-build-webvtt-parser": {
      "execution_order": 6,
      "execution_layer": 3,
      "parallel_with": [
        "ACT-005",
        "ACT-009",
        "ACT-010"
      ],
      "seed_id": "ACT-006",
      "title": "实现 WebVTT 解析与生成模块",
      "type": "build",
      "summary": "翻译前后需解析/重组 WebVTT 格式，保持时间戳一致。这是 LLM 翻译与字幕注入之间的桥梁模块。",
      "acceptance_draft": [
        "解析器可正确解析标准 WebVTT 文件（含 cue ID、时间戳、文本）",
        "生成器可将解析结果还原为有效 WebVTT 字符串",
        "单元测试覆盖各种 VTT 格式（多行文本、样式标签等）",
        "解析后再生成的文件与原文件语义等价",
        "边界情况处理（空文件、格式错误等）"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "WebVTT 解析与生成模块实现完成！解析器支持标准 WebVTT 格式（cue ID、时间戳、多行文本、样式块、区域、注释）。生成器可完整还原 VTT 结构。61 个单元测试全部通过，包含完整的 Round-Trip 验证。",
      "dependencies": [
        "T-20251223-act-004-design-architecture"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "shared-utils"
      ],
      "artifacts": [
        "src/utils/webvtt-parser.ts",
        "src/utils/webvtt-generator.ts",
        "src/utils/__tests__/webvtt.test.ts",
        "src/types/index.ts",
        "Compact/Compact-T-20251223-act-006-build-webvtt-parser-2025-12-23-T173910Z.md"
      ],
      "citations": [
        "EVID-004",
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T18:00:00Z",
      "completed_at": "2025-12-23T17:39:10Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-006",
        "build",
        "core",
        "parser"
      ],
      "code_review": {
        "status": "passed",
        "reviewed_at": "2025-12-24T00:30:00Z",
        "findings_resolved": 3,
        "fixes": [
          "includeNotes default: Changed from false to true in DEFAULT_OPTIONS, ensuring NOTE blocks are preserved during parse→generate round-trips (consistent with includeCueIds/includeStyles/includeRegions defaults)",
          "Region ID parsing: Changed from line.startsWith('id=') to regex /(?:^|\\s)id:([^\\s]+)/ to match WebVTT colon-separated key:value format (e.g., 'id:region1'), fixing silent discard of all REGION blocks",
          "Region ID regex escape fix: Changed /(?:^|\\\\s)id:([^\\\\s]+)/ to /(?:^|\\s)id:([^\\s]+)/ - the double backslash in regex literal was matching literal backslash+s instead of whitespace character class, causing region IDs to capture subsequent settings (e.g., 'region1 width:40%' instead of 'region1')"
        ]
      },
      "completion_summary": {
        "deliverables": [
          "src/utils/webvtt-parser.ts - WebVTT 解析模块 (400+ 行)",
          "src/utils/webvtt-generator.ts - WebVTT 生成模块 (350+ 行)",
          "src/utils/__tests__/webvtt.test.ts - 单元测试 (61 个测试用例)",
          "src/types/index.ts - 新增 WebVTT 类型定义"
        ],
        "key_features": {
          "parser": [
            "parseVTT: 解析完整 VTT 文件为结构化数据",
            "parseTimestamp: 解析时间戳 (HH:MM:SS.mmm 或 MM:SS.mmm)",
            "timestampToMs/msToTimestamp: 时间戳与毫秒互转",
            "isValidVTT: 验证 VTT 格式",
            "stripVTTTags: 移除 VTT 样式标签",
            "getCuesAtTime: 获取指定时间点的字幕",
            "支持 BOM 前缀处理、Style 块、Region 块、Note 注释"
          ],
          "generator": [
            "generateVTT: 从结构化数据生成完整 VTT 字符串",
            "generateCue: 生成单个 cue 块",
            "generateFromCues: 从 cue 数组快速生成 VTT",
            "generateDataUri: 生成 data URI 用于 <track> 注入",
            "generateBlobUrl: 生成 Blob URL (浏览器环境)",
            "replaceCueTexts: 替换字幕文本保持时间戳 (翻译场景)",
            "mergeVTTFiles: 合并多个 VTT 文件",
            "validateVTTFile: 验证 VTT 结构"
          ]
        },
        "types_added": [
          "VTTTimestamp: 时间戳结构",
          "VTTCue: 字幕条目",
          "VTTFile: 完整 VTT 文件结构",
          "VTTRegion: 区域定义",
          "VTTParseResult: 解析结果",
          "VTTGeneratorOptions: 生成器选项"
        ],
        "test_coverage": {
          "total_tests": 61,
          "categories": [
            "Parser 基础解析 (12 tests)",
            "Timestamp 处理 (7 tests)",
            "VTT 验证与工具函数 (8 tests)",
            "Generator 生成 (17 tests)",
            "辅助函数 (12 tests)",
            "Round-Trip 验证 (4 tests)"
          ]
        },
        "next_steps": [
          "与 LLM 翻译模块集成 (ACT-007): 使用 extractCueTexts 提取文本, replaceCueTexts 替换翻译结果",
          "与字幕注入模块集成 (ACT-008): 使用 generateDataUri 生成可注入的 VTT"
        ]
      }
    },
    "T-20251223-act-009-build-popup-settings": {
      "execution_order": 7,
      "execution_layer": 3,
      "parallel_with": [
        "ACT-005",
        "ACT-006",
        "ACT-010"
      ],
      "seed_id": "ACT-009",
      "title": "实现 Popup 设置面板（API Key / 模型选择 / 开关）",
      "type": "build",
      "summary": "FR-04, FR-05 用户配置入口，提供翻译服务选择、API Key 输入、模型选择和字幕替换主开关。",
      "acceptance_draft": [
        "UI 支持选择翻译服务（OpenAI / Gemini）",
        "UI 支持输入 API Key（密码类型输入框）",
        "UI 支持选择模型名称（下拉选择）",
        "UI 包含\"保存并验证\"按钮",
        "验证按钮调用 API 测试连通性，显示结果（可用/错误）",
        "UI 包含\"字幕替换\"主开关",
        "配置可保存/读取（chrome.storage.sync）",
        "开关切换后 1 秒内生效，无需刷新页面"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "Popup 设置面板实现完成！包含翻译服务选择、API Key 输入验证、模型选择、主开关、高级设置等完整功能。Settings Manager 模块提供统一的配置管理接口。34 个单元测试全部通过。",
      "dependencies": [
        "T-20251223-act-004-design-architecture"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 6,
      "interfaces_touched": [
        "popup",
        "storage"
      ],
      "artifacts": [
        "src/popup/popup.html",
        "src/popup/popup.ts",
        "src/popup/popup.css",
        "src/storage/settings-manager.ts",
        "src/storage/__tests__/settings-manager.test.ts",
        "Compact/Compact-T-20251223-act-009-build-popup-settings-2025-12-23-T181906Z.md"
      ],
      "citations": [
        "EVID-001",
        "EVID-005"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T23:30:00Z",
      "completed_at": "2025-12-23T23:30:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-009",
        "build",
        "FR-04",
        "FR-05",
        "ui"
      ],
      "completion_summary": {
        "deliverables": [
          "src/popup/popup.html - 设置面板 UI (130 行)",
          "src/popup/popup.css - 样式表 (350 行)",
          "src/popup/popup.ts - 逻辑与 API 验证 (400 行)",
          "src/storage/settings-manager.ts - 配置管理模块 (300 行)",
          "src/storage/__tests__/settings-manager.test.ts - 单元测试 (34 个测试用例)"
        ],
        "key_features": {
          "ui_components": [
            "翻译服务选择 (OpenAI / Gemini) - 下拉选择",
            "API Key 输入 - 密码类型，支持显示/隐藏切换",
            "模型选择 - 根据服务商动态更新选项",
            "保存并验证按钮 - 调用 API 测试连通性",
            "字幕替换主开关 - Toggle Switch",
            "高级设置 - 自动翻译、预加载、费用估算、进度显示"
          ],
          "api_validation": [
            "OpenAI: 调用 /v1/models 验证 API Key",
            "Gemini: 调用 /v1beta/models 验证 API Key",
            "格式校验: OpenAI Key 必须以 sk- 开头",
            "错误处理: 401/429 等状态码友好提示"
          ],
          "settings_manager": [
            "loadSettings() - 加载配置",
            "saveSettings() - 保存配置",
            "resetSettings() - 重置为默认值",
            "onSettingsChange() - 配置变更监听",
            "isConfigured() / isEnabled() - 状态检查",
            "getModelInfo() / estimateCost() - 费用估算"
          ]
        },
        "provider_models": {
          "openai": ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-4", "gpt-3.5-turbo"],
          "gemini": ["gemini-2.0-flash-exp", "gemini-1.5-pro", "gemini-1.5-flash", "gemini-1.5-flash-8b"]
        },
        "storage": "chrome.storage.sync (带 localStorage 降级)",
        "test_coverage": {
          "total_tests": 34,
          "categories": [
            "DEFAULT_SETTINGS 验证 (3 tests)",
            "PROVIDER_MODELS 验证 (3 tests)",
            "loadSettings/saveSettings (6 tests)",
            "配置工具函数 (9 tests)",
            "SettingsManager 类 (7 tests)"
          ]
        },
        "next_steps": [
          "与 Service Worker 消息桥接集成",
          "集成到 manifest.json 作为 popup",
          "与 Content Script 通信传递配置变更"
        ]
      }
    },
    "T-20251223-act-010-build-local-cache": {
      "execution_order": 8,
      "execution_layer": 3,
      "parallel_with": [
        "ACT-005",
        "ACT-006",
        "ACT-009"
      ],
      "seed_id": "ACT-010",
      "title": "实现本地缓存模块（IndexedDB 存储已翻译字幕）",
      "type": "build",
      "summary": "FR-07 避免重复翻译，支持离线使用。缓存结构需包含课程/课时 ID、原字幕哈希、优化字幕文本、模型版本、时间戳。",
      "acceptance_draft": [
        "使用 IndexedDB 存储翻译结果",
        "缓存键为课程/课时唯一标识",
        "数据结构包含：课程/课时 ID、原字幕哈希、优化字幕文本、模型版本、时间戳",
        "缓存命中时 0 API 调用即可返回字幕",
        "浏览器重启后数据持久",
        "提供缓存查询/写入/删除接口",
        "缓存大小管理（可选 LRU 淘汰）"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "本地缓存模块实现完成！使用 IndexedDB 存储翻译结果，支持课程/课时 ID 作为缓存键，包含原字幕哈希校验、LRU 淘汰机制、完整的 CRUD 接口。38 个单元测试全部通过。",
      "dependencies": [
        "T-20251223-act-004-design-architecture"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "storage",
        "indexeddb"
      ],
      "artifacts": [
        "src/storage/subtitle-cache.ts",
        "src/storage/__tests__/subtitle-cache.test.ts",
        "src/test-setup.ts",
        "Compact/Compact-T-20251223-act-010-build-local-cache-2025-12-23-T184619Z.md"
      ],
      "citations": [
        "EVID-007"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T18:46:19Z",
      "completed_at": "2025-12-23T18:46:19Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-010",
        "build",
        "FR-07",
        "cache",
        "NFR-03"
      ],
      "completion_summary": {
        "deliverables": [
          "src/storage/subtitle-cache.ts - 主模块 (450+ 行)",
          "src/storage/__tests__/subtitle-cache.test.ts - 单元测试 (38 个测试用例)",
          "src/test-setup.ts - Jest 测试配置 (structuredClone polyfill)"
        ],
        "key_features": {
          "storage": [
            "IndexedDB 持久化存储，浏览器重启后数据保留",
            "缓存键: courseId-lectureId 唯一标识",
            "数据结构: 课程/课时 ID、原字幕哈希、翻译 VTT、模型版本、token 消耗、费用估算、时间戳"
          ],
          "crud_operations": [
            "getCache() - 查询缓存，支持哈希校验",
            "setCache() - 写入/更新缓存条目",
            "deleteCache() - 删除单个条目",
            "deleteCourseCache() - 删除整个课程的所有缓存",
            "clearAllCache() - 清空所有缓存"
          ],
          "query_operations": [
            "getCourseEntries() - 获取课程的所有缓存条目",
            "getAllEntries() - 获取全部缓存条目",
            "getCacheCount() - 获取缓存条目总数",
            "getCacheStats() - 获取缓存统计信息 (大小、token 消耗、费用累计等)"
          ],
          "lru_eviction": [
            "基于 updatedAt 时间戳的 LRU 淘汰策略",
            "可配置最大条目数 (默认 500)",
            "可配置最大缓存大小 (默认 100MB)",
            "touchCache() 更新访问时间",
            "evictIfNeeded() 自动触发淘汰",
            "cleanupCache() 手动清理"
          ],
          "api_interface": [
            "函数式 API: getCache, setCache, deleteCache 等",
            "类式 API: SubtitleCache 类，支持选项配置",
            "单例导出: subtitleCache 默认实例"
          ]
        },
        "types_used": [
          "SubtitleCacheEntry - 缓存条目类型 (已在 types/index.ts 定义)",
          "CacheOptions - 缓存配置选项",
          "CacheStats - 缓存统计信息",
          "CacheLookupResult - 缓存查询结果",
          "CacheEntryInput - 缓存写入输入"
        ],
        "test_coverage": {
          "total_tests": 38,
          "categories": [
            "generateCacheKey (3 tests)",
            "setCache/getCache (4 tests)",
            "deleteCache (2 tests)",
            "deleteCourseCache (2 tests)",
            "clearAllCache (1 test)",
            "getCourseEntries (2 tests)",
            "getAllEntries (2 tests)",
            "getCacheCount (1 test)",
            "getCacheStats (2 tests)",
            "evictIfNeeded (2 tests)",
            "touchCache (2 tests)",
            "cleanupCache (1 test)",
            "SubtitleCache class (10 tests)",
            "subtitleCache singleton (2 tests)",
            "Utility functions (2 tests)"
          ]
        },
        "next_steps": [
          "与 LLM 翻译模块集成 (ACT-007): 翻译完成后调用 setCache 存储",
          "与字幕抓取模块集成 (ACT-005): 抓取前调用 getCache 检查缓存",
          "与字幕版本检测模块集成 (ACT-012): 使用 originalHash 校验字幕变化"
        ]
      }
    },
    "T-20251223-act-007-build-llm-translator": {
      "execution_order": 9,
      "execution_layer": 4,
      "parallel_with": [],
      "seed_id": "ACT-007",
      "title": "实现 LLM 翻译模块（支持 OpenAI / Gemini）",
      "type": "build",
      "summary": "FR-02 核心功能，调用用户配置的 LLM API 进行翻译。需支持 OpenAI GPT 系列和 Google Gemini，包含课程元数据作为上下文。",
      "acceptance_draft": [
        "支持 OpenAI Chat Completions API 调用",
        "支持 Google Gemini API 调用",
        "Prompt 包含课程名/章节名等元数据以提升术语翻译准确性",
        "Prompt 明确要求保持时间戳格式，仅翻译文本部分",
        "单元测试验证 Prompt 构造正确",
        "Mock API 响应可解析为有效 VTT 结构",
        "超时处理（60 秒上限）",
        "错误重试机制"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "LLM 翻译模块实现完成并重构！采用新的直接 VTT 翻译方案（输入完整 VTT → LLM → 输出翻译后的 VTT），支持 GPT-5.x 和 Gemini 2.5/3.x 新模型，包含时长分批（10分钟/批次）、流式响应、Service Worker 保活机制、VTT 响应验证、超时处理和错误重试。接口已简化：移除 sourceLanguage/targetLanguage 参数，硬编码为英文→简体中文翻译。60 个单元测试全部通过（全项目 223 测试）。",
      "dependencies": [
        "T-20251223-act-004-design-architecture",
        "T-20251223-act-006-build-webvtt-parser"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 8,
      "interfaces_touched": [
        "service-worker",
        "openai-api",
        "gemini-api"
      ],
      "artifacts": [
        "src/services/translator.ts",
        "src/services/openai-client.ts",
        "src/services/gemini-client.ts",
        "src/services/__tests__/translator.test.ts",
        "src/storage/settings-manager.ts"
      ],
      "citations": [
        "EVID-004",
        "EVID-005",
        "EVID-009"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-23T23:59:00Z",
      "completed_at": "2025-12-23T23:59:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-007",
        "build",
        "core",
        "FR-02",
        "llm",
        "refactored"
      ],
      "completion_summary": {
        "deliverables": [
          "src/services/translator.ts - 主翻译模块 (850 行) [重构]",
          "src/services/openai-client.ts - OpenAI API 客户端 (490 行)",
          "src/services/gemini-client.ts - Gemini API 客户端 (560 行)",
          "src/services/__tests__/translator.test.ts - 单元测试 (60 个测试用例)",
          "src/storage/settings-manager.ts - 更新模型列表"
        ],
        "refactoring_summary": {
          "old_approach": "提取文本 → 翻译 → 重组 VTT",
          "new_approach": "直接输入完整 VTT → LLM → 输出翻译后的完整 VTT",
          "rationale": "利用 GPT-5.1/Gemini-3.0-Pro 等高级模型能力，直接生成格式正确的翻译 VTT，简化流程并提高可靠性",
          "interface_simplification": "移除 sourceLanguage/targetLanguage 参数，硬编码为 English → Chinese (简体中文)"
        },
        "key_features": {
          "translator": [
            "translateVTT(): 主入口，直接 VTT 翻译",
            "splitVTTByDuration(): 按时长分批（默认 10 分钟/批）",
            "parseTranslatedVTTResponse(): 解析 LLM 输出的 VTT",
            "validateTranslatedVTT(): 验证时间戳和 cue 数量匹配",
            "buildSystemPrompt(): 构建系统提示（固定英文→中文翻译，支持课程上下文）",
            "buildUserPrompt(): 构建 VTT 翻译请求",
            "estimateTranslationCost(): 翻译前费用估算",
            "Translator class: 面向对象接口",
            "重试机制: 可配置重试次数，指数退避"
          ],
          "openai_client": [
            "chatCompletion(): Chat Completions API 调用",
            "流式响应处理 (SSE)",
            "Service Worker 保活机制 (25s interval)",
            "validateApiKey(): API Key 验证",
            "estimateTokens(): Token 估算"
          ],
          "gemini_client": [
            "generateContent(): Gemini API 调用",
            "流式响应处理",
            "Service Worker 保活机制",
            "validateApiKey(): API Key 验证",
            "convertFromOpenAIFormat(): 消息格式转换"
          ]
        },
        "supported_models": {
          "openai": ["gpt-5.2", "gpt-5.1", "gpt-5-pro", "gpt-5"],
          "gemini": ["gemini-3-pro-preview", "gemini-3-flash-preview", "gemini-2.5-pro", "gemini-2.5-flash"]
        },
        "test_coverage": {
          "total_tests": 60,
          "categories": [
            "Prompt 构建 (8 tests)",
            "时长分批 splitVTTByDuration (5 tests)",
            "时长计算 getVTTDurationSpan (2 tests)",
            "VTT 响应解析 parseTranslatedVTTResponse (6 tests)",
            "VTT 验证 validateTranslatedVTT (3 tests)",
            "Token/费用估算 (11 tests)",
            "翻译流程 translateVTT (12 tests)",
            "工具函数 (2 tests)",
            "Translator 类 (8 tests)",
            "settings-manager 更新 (3 tests)"
          ]
        },
        "next_steps": [
          "与字幕注入模块集成 (ACT-008)",
          "与本地缓存模块集成 (ACT-010): 翻译后存储结果",
          "与 Service Worker 消息系统集成"
        ]
      }
    },
    "T-20251223-act-008-build-track-injector": {
      "execution_order": 10,
      "execution_layer": 5,
      "parallel_with": [
        "ACT-012",
        "ACT-016"
      ],
      "seed_id": "ACT-008",
      "title": "实现字幕注入模块（动态创建 <track> 并激活）",
      "type": "build",
      "summary": "FR-03 核心功能，将翻译结果以原生 <track> 元素形式注入 Udemy 播放器，呈现给用户。",
      "acceptance_draft": [
        "动态创建 <track> 元素并添加到视频 DOM",
        "使用 data URI 或 chrome.runtime.getURL 绕过 CSP",
        "Udemy 播放器字幕菜单显示\"中文（优化）\"轨道选项",
        "选中后字幕同步视频时间轴正常显示",
        "全屏模式下字幕样式与原生一致",
        "窗口大小变化时字幕自动适配"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "字幕注入模块实现完成！支持 Data URI、Blob URL、TextTrack API 三种注入方式，包含轨道激活/停用、内容更新、自动清理等功能。54 个单元测试全部通过。Code Review 5 个问题已全部修复（2 P1 + 3 P2）。",
      "dependencies": [
        "T-20251223-act-001-spike-track-inject",
        "T-20251223-act-005-build-subtitle-fetch",
        "T-20251223-act-007-build-llm-translator"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 6,
      "interfaces_touched": [
        "content-script",
        "video-player-dom"
      ],
      "artifacts": [
        "src/content/track-injector.ts",
        "src/content/__tests__/track-injector.test.ts",
        "Compact/Compact-T-20251223-act-008-build-track-injector-2025-12-23-T203227Z.md"
      ],
      "citations": [
        "EVID-006",
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T04:45:00Z",
      "completed_at": "2025-12-23T20:32:27Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-008",
        "build",
        "core",
        "FR-03"
      ],
      "code_review": {
        "status": "passed",
        "reviewed_at": "2025-12-24T04:45:00Z",
        "findings_resolved": 5,
        "fixes": [
          "[P1] injectTrackCues: 重构实现方式，改用 HTMLTrackElement + 空 VTT data URI 代替直接使用 video.addTextTrack()，确保 API 一致性 - 现在正确调用 registerTrack()、setupCleanup()、dispatch TRACK_INJECTED_EVENT，并在结果中返回 track 元素",
          "[P1] injectTrackBlob: 添加已存在轨道检测，调用 removeTrack() 移除同 label 的旧轨道后再注入新轨道，确保 Blob URL 正确回收，与 injectTrack/injectTrackCues 行为一致",
          "[P2] updateTrackContent: InjectedTrackInfo 接口新增 kind 属性，三个注入方法 (injectTrack/injectTrackBlob/injectTrackCues) 注册时保存 kind，updateTrackContent 现在正确传递 kind: trackInfo.kind 参数，避免重译时将 captions 降级为 subtitles",
          "[P2] updateTrackContent: InjectedTrackInfo 接口新增 exclusive 属性，三个注入方法注册时保存 exclusive 值。新增 TrackUpdateOptions 接口，updateTrackContent 现在使用 options.exclusive ?? trackInfo.exclusive 保持原始独占设置，避免更新非独占轨道时意外禁用其他轨道",
          "[P2] activateTrack/injectTrackCues: 独占模式下禁用其他轨道时同步清除其 InjectedTrackInfo.isActive 标志，确保 getActiveInjectedTrack() 返回正确的活跃轨道状态"
        ]
      },
      "completion_summary": {
        "deliverables": [
          "src/content/track-injector.ts - 主模块 (900+ 行)",
          "src/content/__tests__/track-injector.test.ts - 单元测试 (54 个测试用例)"
        ],
        "key_features": {
          "injection_methods": [
            "injectTrack() - Data URI 方式注入 (推荐，无 CSP 问题)",
            "injectTrackBlob() - Blob URL 方式注入 (备选)",
            "injectTrackCues() - TextTrack API 方式注入 (纯内存操作)"
          ],
          "track_management": [
            "activateTrack() - 激活轨道，支持独占模式",
            "deactivateTrack() - 停用轨道",
            "setTrackMode() - 设置轨道模式 (disabled/hidden/showing)",
            "removeTrack() - 移除单个轨道",
            "removeAllTracks() - 移除所有注入的轨道",
            "updateTrackContent() - 更新轨道内容"
          ],
          "query_functions": [
            "getInjectedTracks() - 获取所有注入的轨道",
            "hasInjectedTracks() - 检查是否有注入的轨道",
            "getActiveInjectedTrack() - 获取当前激活的轨道",
            "findTrackByLabel() - 按标签查找轨道"
          ],
          "auto_cleanup": [
            "MutationObserver 监控视频元素移除",
            "Blob URL 自动回收",
            "WeakMap 管理轨道状态避免内存泄漏"
          ],
          "events": [
            "udemycaptionplus:trackinjected - 轨道注入事件",
            "udemycaptionplus:trackactivated - 轨道激活事件"
          ]
        },
        "api_exports": [
          "函数式 API: injectTrack, activateTrack, removeTrack 等",
          "类式 API: TrackInjector 类",
          "常量: DEFAULT_LABEL ('中文（优化）'), DEFAULT_LANGUAGE ('zh-CN'), INJECTED_TRACK_ATTR"
        ],
        "test_coverage": {
          "total_tests": 54,
          "categories": [
            "常量验证 (4 tests)",
            "injectTrack 功能 (8 tests)",
            "injectTrackBlob 功能 (3 tests)",
            "injectTrackCues 功能 (5 tests)",
            "轨道激活/停用 (5 tests)",
            "轨道移除 (3 tests)",
            "轨道更新 (2 tests)",
            "查询函数 (6 tests)",
            "TrackInjector 类 (12 tests)",
            "边界情况 (4 tests)",
            "集成测试 (2 tests)"
          ]
        },
        "next_steps": [
          "与 Content Script 入口点集成",
          "与 LLM 翻译模块配合使用翻译后的 VTT",
          "与消息系统集成接收翻译完成事件",
          "验证 Video.js CC 菜单是否自动更新（可能需要手动触发）"
        ]
      }
    },
    "T-20251223-act-012-build-retranslate": {
      "execution_order": 11,
      "execution_layer": 5,
      "parallel_with": [
        "ACT-008",
        "ACT-016"
      ],
      "seed_id": "ACT-012",
      "title": "实现字幕版本检测与重译功能",
      "type": "build",
      "summary": "FR-08 支持字幕更新与用户手动刷新，当原字幕版本变化或用户主动触发时重新翻译。",
      "acceptance_draft": [
        "检测原字幕哈希变化",
        "原字幕更新时自动触发重译并更新缓存",
        "Popup 设置面板提供\"重新翻译当前课\"按钮",
        "点击按钮后发起新翻译请求并覆盖缓存",
        "重译过程显示进度提示"
      ],
      "lane": "next",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "字幕版本检测与重译功能实现完成！新增 version-checker 基于 originalHash 校验缓存有效性，支持字幕哈希变化自动重译与强制重译覆盖缓存；Popup 增加“重新翻译当前课”按钮并实时显示进度；补齐 Service Worker 翻译处理与 Content Script 入口点联动缓存/注入。新增 5 个单元测试全部通过，并通过 type-check。",
      "dependencies": [
        "T-20251223-act-007-build-llm-translator",
        "T-20251223-act-010-build-local-cache"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 3,
      "interfaces_touched": [
        "popup",
        "service-worker",
        "storage"
      ],
      "artifacts": [
        "src/services/version-checker.ts",
        "src/services/__tests__/version-checker.test.ts",
        "src/utils/hash.ts",
        "src/background/service-worker.ts",
        "src/content/content-script.ts",
        "src/popup/popup.html",
        "src/popup/popup.ts",
        "src/popup/popup.css",
        "src/services/translator.ts",
        "src/services/__tests__/translator.test.ts",
        "src/content/subtitle-fetcher.ts",
        "src/types/index.ts"
      ],
      "citations": [
        "EVID-001"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T00:20:26Z",
      "completed_at": "2025-12-23T22:11:01Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-012",
        "build",
        "FR-08"
      ],
      "code_review": {
        "status": "passed",
        "reviewed_at": "2025-12-24T00:20:26Z",
        "findings_resolved": 1,
        "fixes": [
          "[P1] preloadLecture: 预加载翻译现在会调用 addSessionCost()/updateSessionCostState() 计入会话累计（tokens/USD），与正常翻译入口保持一致，避免启用 preload 时绕过成本统计"
        ]
      },
      "completion_summary": {
        "deliverables": [
          "src/services/version-checker.ts - 字幕版本检测与重译决策",
          "src/background/service-worker.ts - 翻译请求处理、缓存校验与进度广播",
          "src/content/content-script.ts - Popup 触发重译与翻译结果注入",
          "src/popup/popup.html / src/popup/popup.ts / src/popup/popup.css - 重译按钮与进度提示 UI"
        ],
        "key_features": {
          "versioning": [
            "originalHash 校验缓存命中有效性",
            "字幕哈希变化时自动触发重译并更新缓存",
            "force 模式强制覆盖缓存（手动重译）"
          ],
          "ux": [
            "Popup 提供“重新翻译当前课”按钮",
            "重译过程在 Popup 实时显示进度与结果"
          ],
          "integration": [
            "Service Worker 负责翻译与缓存写入",
            "Content Script 负责抓取字幕与注入译文轨道"
          ]
        },
        "test_coverage": {
          "added_tests": 5,
          "commands": [
            "npm test",
            "npm run type-check"
          ]
        }
      }
    },
    "T-20251223-act-016-build-cost-estimate": {
      "execution_order": 12,
      "execution_layer": 5,
      "parallel_with": [
        "ACT-008",
        "ACT-012"
      ],
      "seed_id": "ACT-016",
      "title": "实现 API 费用/字数估算显示",
      "type": "build",
      "summary": "R-03 风险缓解，帮助用户在翻译前了解预估成本，翻译后显示实际消耗。",
      "acceptance_draft": [
        "翻译前根据字幕长度显示预估 Token 数",
        "翻译前显示预估费用（基于当前模型定价）",
        "翻译后显示实际消耗 Token 数和费用",
        "累计显示本次会话总费用"
      ],
      "lane": "later",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "已实现费用/Token 估算与展示：Service Worker 在翻译前发送 COST_ESTIMATE（预估 tokens/费用），翻译完成后发送实际 tokens/费用并累计到会话总额；Popup 新增 CostDisplay 区域展示“预估/本次/会话累计”，并支持缓存命中时展示历史消耗。已补齐预加载翻译计费：preload 模式下的后台翻译同样计入会话累计，避免绕过成本统计。",
      "dependencies": [
        "T-20251223-act-007-build-llm-translator",
        "T-20251223-act-009-build-popup-settings"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "popup",
        "service-worker"
      ],
      "artifacts": [
        "src/utils/cost-estimator.ts",
        "src/storage/session-cost.ts",
        "src/background/service-worker.ts",
        "src/popup/popup.html",
        "src/popup/popup.ts",
        "src/popup/popup.css",
        "src/types/index.ts",
        "src/utils/__tests__/cost-estimator.test.ts"
      ],
      "citations": [
        "EVID-009",
        "EVID-010"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T00:20:26Z",
      "completed_at": "2025-12-23T23:20:42Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-016",
        "build",
        "R-03",
        "ux"
      ],
      "completion_summary": {
        "deliverables": [
          "src/utils/cost-estimator.ts - 模型定价表与费用计算工具",
          "src/storage/session-cost.ts - 会话级 token/费用累计（chrome.storage.session）",
          "src/background/service-worker.ts - 翻译前估算广播 + 翻译后实际消耗与会话累计",
          "src/popup/popup.html / src/popup/popup.ts / src/popup/popup.css - CostDisplay UI 与消息监听",
          "src/utils/__tests__/cost-estimator.test.ts - 单元测试"
        ],
        "key_features": [
          "翻译前预估：基于字幕内容估算 tokens，并按模型定价计算预估费用",
          "翻译后统计：展示实际 tokens 与费用，并累计到本次会话总费用",
          "预加载计费：后台 preload 翻译同样会累计到会话总费用，避免开启预加载后成本统计失真",
          "Popup 展示：预估 / 本次 / 会话累计（支持缓存命中显示历史消耗）",
          "开关控制：showCostEstimate 关闭时隐藏费用区块"
        ],
        "verification": {
          "tests": "npm test ✅ (8 suites / 285 tests)",
          "type_check": "npm run type-check ✅",
          "build": "npm run build ✅"
        }
      }
    },
    "T-20251223-act-011-build-preload": {
      "execution_order": 13,
      "execution_layer": 6,
      "parallel_with": [
        "ACT-013",
        "ACT-014",
        "ACT-015"
      ],
      "seed_id": "ACT-011",
      "title": "实现预加载模块（后台翻译下一课字幕）",
      "type": "build",
      "summary": "FR-06 提升连续观看体验，当前课播放时后台静默翻译下一课字幕并缓存。",
      "acceptance_draft": [
        "当前课播放时自动识别下一课 ID",
        "后台静默抓取下一课字幕并翻译",
        "翻译结果存入本地缓存",
        "当前课播放结束前下一课字幕已缓存（可在 DevTools Storage 验证）",
        "用户跳转时直接命中缓存",
        "用户快速跳转时可中断不必要的翻译请求"
      ],
      "lane": "next",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "预加载模块实现完成：Content Script 自动识别下一课（Curriculum API 优先，UD 全局兜底），向 Service Worker 发送 PRELOAD_NEXT；Service Worker 后台抓取下一课字幕、调用 LLM 翻译并写入 IndexedDB 缓存；同一 Tab 新预加载请求会自动中断旧任务以适配快速跳转。预加载翻译同样会计入 session cost 会话累计，避免绕过成本统计/预算。新增 5 个单元测试通过，并通过 type-check/build。",
      "dependencies": [
        "T-20251223-act-002-spike-next-lecture",
        "T-20251223-act-007-build-llm-translator",
        "T-20251223-act-010-build-local-cache"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 6,
      "interfaces_touched": [
        "service-worker",
        "content-script",
        "storage"
      ],
      "artifacts": [
        "src/services/preloader.ts",
        "src/background/service-worker.ts",
        "src/content/content-script.ts",
        "src/content/next-lecture-detector.ts",
        "src/types/index.ts",
        "src/services/__tests__/preloader.test.ts",
        "src/content/__tests__/next-lecture-detector.test.ts"
      ],
      "citations": [
        "EVID-001"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T00:20:26Z",
      "completed_at": "2025-12-23T23:59:51Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-011",
        "build",
        "FR-06",
        "preload"
      ],
      "completion_summary": {
        "deliverables": [
          "src/services/preloader.ts - 后台预加载（抓取字幕/翻译/写入缓存，支持 AbortSignal 取消）",
          "src/content/next-lecture-detector.ts - 下一课 ID 检测（Curriculum API 优先 + UD fallback）",
          "src/background/service-worker.ts - PRELOAD_NEXT 消息处理与按 Tab 中断旧预加载",
          "src/content/content-script.ts - 触发预加载 + SPA 路由变更自动翻译/预加载",
          "src/services/__tests__/preloader.test.ts - 预加载缓存写入/命中测试",
          "src/content/__tests__/next-lecture-detector.test.ts - 下一课检测测试"
        ],
        "key_features": {
          "detection": [
            "自动识别下一课 ID（Curriculum API 优先，UD 全局兜底）"
          ],
          "preload_pipeline": [
            "Service Worker 后台抓取下一课 WebVTT 并静默翻译",
            "预加载翻译同样计入会话累计 tokens/费用（session-cost），避免开启 preload 时成本统计失真",
            "翻译结果写入 IndexedDB（SubtitleCache），跳转后可直接命中缓存"
          ],
          "cancellation": [
            "同一 Tab 新 PRELOAD_NEXT 到来时自动 abort 旧预加载任务，减少无用翻译请求"
          ]
        },
        "test_coverage": {
          "added_tests": 5,
          "commands": [
            "npm test",
            "npm run type-check",
            "npm run build"
          ]
        }
      }
    },
    "T-20251223-act-013-build-loading-indicator": {
      "execution_order": 14,
      "execution_layer": 6,
      "parallel_with": [
        "ACT-011",
        "ACT-014",
        "ACT-015"
      ],
      "seed_id": "ACT-013",
      "title": "添加加载状态提示（翻译中...）",
      "type": "build",
      "summary": "NFR-02 用户体验优化，翻译期间显示加载提示避免用户困惑。",
      "acceptance_draft": [
        "翻译请求发起时视频区域显示\"字幕翻译中…\"提示",
        "提示样式与 Udemy 播放器风格一致",
        "翻译完成后提示自动消失",
        "超时时显示错误提示并允许重试"
      ],
      "lane": "next",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "加载状态提示模块实现完成！支持 loading/success/error 三种状态，样式与 Udemy 播放器风格一致（紫色主题 #a435f0），包含自动隐藏、重试按钮、XSS 防护等功能。已集成到 content-script.ts，根据 showLoadingIndicator 设置显示/隐藏。66 个单元测试全部通过。",
      "dependencies": [
        "T-20251223-act-008-build-track-injector"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 2,
      "interfaces_touched": [
        "content-script",
        "ui"
      ],
      "artifacts": [
        "src/content/loading-indicator.ts",
        "src/content/__tests__/loading-indicator.test.ts",
        "src/content/content-script.ts",
        "Compact/Compact-T-20251223-act-013-build-loading-indicator-2025-12-24-T063500Z.md"
      ],
      "citations": [
        "EVID-001"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T11:15:00Z",
      "completed_at": "2025-12-24T06:35:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-013",
        "build",
        "NFR-02",
        "ux"
      ],
      "code_review": {
        "status": "passed",
        "reviewed_at": "2025-12-24T11:15:00Z",
        "findings_resolved": 2,
        "fixes": [
          "[P1] findVideoContainer: 将无效的 CSS 选择器 '.video-player--container--*' 替换为有效的属性选择器 '[class*=\"video-player--container--\"]'，修复因无效选择器导致 video.closest() 抛出 DOMException 的问题",
          "[P2] createIndicatorElement: 移除硬编码的 id 属性以避免多视频页面产生重复 DOM ID。indicator 元素已通过 WeakMap 按 video 跟踪，CSS 使用 class 选择器，无需 ID"
        ]
      },
      "completion_summary": {
        "deliverables": [
          "src/content/loading-indicator.ts - 加载状态提示模块 (550+ 行)",
          "src/content/__tests__/loading-indicator.test.ts - 单元测试 (67 个测试用例)",
          "src/content/content-script.ts - 集成加载提示功能"
        ],
        "key_features": {
          "indicator_states": [
            "loading: 显示旋转动画 + '字幕翻译中…' / '正在重新翻译…'",
            "success: 显示勾选图标 + '翻译完成' / '缓存命中'，3秒后自动隐藏",
            "error: 显示错误图标 + 错误详情 + 重试/关闭按钮"
          ],
          "ui_styling": [
            "紫色主题 (#a435f0) 与 Udemy 播放器风格一致",
            "支持 5 种位置：top-left, top-right, bottom-left, bottom-right, center",
            "平滑的 CSS 过渡动画",
            "响应式定位，适配全屏模式"
          ],
          "api_interface": [
            "函数式 API: showLoadingIndicator, showSuccessIndicator, showErrorIndicator, hideLoadingIndicator",
            "类式 API: LoadingIndicator 类封装",
            "状态查询: getIndicatorStatus, isIndicatorVisible",
            "消息更新: updateLoadingMessage"
          ],
          "integration": [
            "requestTranslation: 翻译开始时显示加载提示",
            "CACHE_HIT: 缓存命中时显示成功提示",
            "TRANSLATION_COMPLETE: 翻译完成显示成功/错误提示",
            "cancelActiveTranslation: 取消翻译时隐藏提示",
            "受 showLoadingIndicator 设置控制"
          ],
          "security": [
            "XSS 防护：HTML 内容转义",
            "WeakMap 状态管理：避免内存泄漏"
          ]
        },
        "test_coverage": {
          "total_tests": 67,
          "categories": [
            "Constants (2 tests)",
            "showLoadingIndicator (10 tests)",
            "showSuccessIndicator (6 tests)",
            "showErrorIndicator (10 tests)",
            "hideLoadingIndicator (4 tests)",
            "removeLoadingIndicator (3 tests)",
            "getIndicatorStatus (4 tests)",
            "isIndicatorVisible (3 tests)",
            "updateLoadingMessage (3 tests)",
            "LoadingIndicator class (11 tests)",
            "XSS Prevention (2 tests)",
            "Multiple video elements (1 test)",
            "Position variants (5 tests)",
            "Style injection (2 tests)"
          ]
        },
        "next_steps": [
          "在真实 Udemy 页面验证视觉效果",
          "测试全屏模式下的提示显示",
          "与 Popup 设置的 showLoadingIndicator 开关联动"
        ]
      }
    },
    "T-20251223-act-014-doc-privacy-policy": {
      "execution_order": 15,
      "execution_layer": 6,
      "parallel_with": [
        "ACT-011",
        "ACT-013",
        "ACT-015"
      ],
      "seed_id": "ACT-014",
      "title": "编写隐私政策与扩展说明文档",
      "type": "doc",
      "summary": "Chrome Web Store 审核要求；用户知情同意。需说明数据仅存本地、直连官方 API。",
      "acceptance_draft": [
        "隐私政策说明数据仅存本地浏览器",
        "隐私政策说明 API Key 仅用于直连官方服务",
        "隐私政策说明不收集用户个人信息",
        "README 包含安装指南",
        "README 包含使用说明（配置 API Key、开启字幕等）",
        "README 包含 FAQ"
      ],
      "lane": "later",
      "priority_suggested": "P2",
      "status": "completed",
      "dependencies": [],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 3,
      "interfaces_touched": [
        "docs"
      ],
      "artifacts": [
        "PRIVACY.md",
        "README.md"
      ],
      "citations": [
        "EVID-007",
        "EVID-011"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T20:05:00Z",
      "completed_at": "2025-12-24T20:05:00Z",
      "owner": "tbd",
      "tags": [
        "seed:ACT-014",
        "doc",
        "chrome-store"
      ],
      "code_review": {
        "reviewed_at": "2025-12-24T12:01:40Z",
        "findings": [
          {
            "id": "CR-014-001",
            "title": "[P2] Fix placeholder repo URL in install steps",
            "priority": 2,
            "status": "resolved",
            "location": "README.md:17-21",
            "resolution": "Updated clone URL from your-username to VVittgenstein",
            "resolved_at": "2025-12-24T20:05:00Z"
          },
          {
            "id": "CR-014-002",
            "title": "[P2] Update privacy policy date to match current release",
            "priority": 2,
            "status": "resolved",
            "location": "PRIVACY.md:1-4",
            "resolution": "Updated date from 2024-12-24 to 2025-12-24",
            "resolved_at": "2025-12-24T19:15:00Z"
          }
        ],
        "open_count": 0,
        "resolved_count": 2
      }
    },
    "T-20251223-act-015-build-e2e-monitor": {
      "execution_order": 16,
      "execution_layer": 6,
      "parallel_with": [
        "ACT-011",
        "ACT-013",
        "ACT-014"
      ],
      "seed_id": "ACT-015",
      "title": "建立 E2E 测试（Playwright）监控 Udemy DOM 变化",
      "type": "build",
      "summary": "R-01 风险缓解，通过 E2E 测试及时发现 Udemy 网站变更导致的功能失效。",
      "acceptance_draft": [
        "Playwright 测试覆盖字幕抓取和注入核心流程",
        "CI 定期运行测试（每日或每周）",
        "DOM 结构变化时测试失败并告警",
        "测试报告可追溯失败原因"
      ],
      "lane": "later",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "已建立 Playwright E2E 监控：覆盖视频元素识别（按扩展选择器契约）、字幕 VTT 响应观测与可抓取性校验、Data URI <track> 注入并激活验证。新增 GitHub Actions 定期（每周）运行并上传 Playwright 报告/trace；失败即触发 Actions 通知。支持通过 secrets.UDEMY_E2E_STORAGE_STATE_JSON 注入登录态以访问课时页面。",
      "dependencies": [
        "T-20251223-act-008-build-track-injector"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 6,
      "interfaces_touched": [
        "e2e-tests",
        "ci"
      ],
      "artifacts": [
        "tests/e2e/udemy-subtitle.spec.ts",
        "playwright.config.ts",
        ".github/workflows/e2e-monitor.yml"
      ],
      "citations": [
        "EVID-008"
      ],
      "created_at": "2025-12-23T12:00:00Z",
      "updated_at": "2025-12-24T12:54:00Z",
      "completed_at": "2025-12-24T12:54:00Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-015",
        "build",
        "test",
        "R-01"
      ]
    },
    "T-20251223-act-017-build-manifest": {
      "execution_order": 17,
      "execution_layer": 7,
      "parallel_with": [],
      "seed_id": "ACT-017",
      "title": "创建 manifest.json 扩展配置文件",
      "type": "build",
      "summary": "Chrome 扩展核心配置文件，定义扩展元信息、权限、入口点。此为阻断性任务，无此文件扩展无法安装。",
      "acceptance_draft": [
        "manifest_version 设为 3 (Manifest V3)",
        "声明必要权限: storage, activeTab, host_permissions (udemy.com)",
        "配置 Service Worker 入口: dist/background/service-worker.js",
        "配置 Content Script: dist/content/content-script.js，匹配 udemy.com 课程页",
        "配置 Popup: src/popup/popup.html",
        "填写扩展元信息 (name, version, description)",
        "扩展可成功加载到 Chrome 开发者模式"
      ],
      "lane": "now",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "已创建 dist/manifest.json（Manifest V3）并配置 Service Worker / Content Script / Popup 入口；同时补齐 dist 内 ESM import 的 .js 扩展名，确保 Chrome 可加载模块依赖。",
      "dependencies": [
        "T-20251223-act-004-design-architecture"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 1,
      "interfaces_touched": [
        "manifest",
        "chrome-extension"
      ],
      "artifacts": [
        "dist/manifest.json",
        "dist/popup/popup.html",
        "dist/popup/popup.css"
      ],
      "citations": [
        "EVID-011"
      ],
      "created_at": "2025-12-24T22:00:00Z",
      "updated_at": "2025-12-24T22:47:57Z",
      "completed_at": "2025-12-24T22:47:57Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-017",
        "build",
        "blocking",
        "mvp-critical"
      ],
      "completion_summary": {
        "deliverables": [
          "dist/manifest.json - Manifest V3 配置文件",
          "dist/popup/popup.html - Popup 静态入口（复制自 src/popup/popup.html）",
          "dist/popup/popup.css - Popup 样式（复制自 src/popup/popup.css）"
        ],
        "key_config": {
          "background": "background/service-worker.js (type=module)",
          "content_script": "content/content-script.js (matches: *://*.udemy.com/course/*/learn/lecture/*)",
          "popup": "popup/popup.html",
          "permissions": ["storage", "activeTab"],
          "host_permissions": ["*://*.udemy.com/*"]
        },
        "notes": [
          "修正 dist 下 ESM import specifier，统一补全 .js 扩展名以符合浏览器模块加载规则"
        ]
      }
    },
    "T-20251223-act-018-build-icons": {
      "execution_order": 18,
      "execution_layer": 7,
      "parallel_with": [
        "ACT-017"
      ],
      "seed_id": "ACT-018",
      "title": "创建扩展图标文件",
      "type": "build",
      "summary": "Chrome 扩展图标，用于工具栏、扩展管理页、Chrome Web Store 展示。",
      "acceptance_draft": [
        "创建 16x16, 48x48, 128x128 三种尺寸的 PNG 图标",
        "图标设计体现字幕翻译功能（如带中文的气泡或CC标志）",
        "manifest.json 正确引用图标路径",
        "扩展加载后工具栏显示正确图标"
      ],
      "lane": "next",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "已生成 dist/icons 下 16/48/128 PNG 扩展图标，并在 dist/manifest.json 中配置 icons 与 action.default_icon 引用这些资源（MVP 占位图标：蓝色背景 + 气泡 +「中」）。",
      "dependencies": [
        "T-20251223-act-017-build-manifest"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 2,
      "interfaces_touched": [
        "assets",
        "manifest"
      ],
      "artifacts": [
        "dist/icons/icon16.png",
        "dist/icons/icon48.png",
        "dist/icons/icon128.png",
        "dist/manifest.json"
      ],
      "citations": [],
      "created_at": "2025-12-24T22:00:00Z",
      "updated_at": "2025-12-24T15:22:20Z",
      "completed_at": "2025-12-24T15:22:20Z",
      "owner": "codex-cli",
      "tags": [
        "seed:ACT-018",
        "build",
        "assets"
      ],
      "completion_summary": {
        "deliverables": [
          "dist/icons/icon16.png - 扩展图标 (16x16 PNG)",
          "dist/icons/icon48.png - 扩展图标 (48x48 PNG)",
          "dist/icons/icon128.png - 扩展图标 (128x128 PNG)"
        ],
        "manifest_updates": [
          "dist/manifest.json: icons / action.default_icon -> icons/icon{size}.png"
        ],
        "notes": [
          "当前为 MVP 占位图标：蓝色背景 + 气泡 +「中」字符；后续可替换为更精细设计但保持路径不变"
        ]
      }
    },
    "T-20251223-act-019-e2e-validation": {
      "execution_order": 19,
      "execution_layer": 8,
      "parallel_with": [],
      "seed_id": "ACT-019",
      "title": "真实环境端到端验证",
      "type": "validation",
      "summary": "在真实 Udemy 页面验证扩展完整功能流程，确保所有模块协同工作正常。",
      "acceptance_draft": [
        "扩展成功加载到 Chrome（无控制台错误）",
        "打开 Udemy 课程视频页，自动检测到视频和字幕",
        "配置 API Key 后点击翻译，字幕成功翻译并注入",
        "翻译后的字幕在播放器菜单可选择",
        "字幕与视频时间轴同步正确",
        "全屏模式下字幕正常显示",
        "缓存命中时直接显示已翻译字幕",
        "预加载下一课功能正常",
        "Popup 设置面板各选项生效",
        "费用估算正确显示"
      ],
      "lane": "next",
      "priority_suggested": "P0",
      "status": "completed",
      "status_note": "修复ES Module打包问题：(1)使用esbuild打包为IIFE格式单文件，解决Service Worker无效问题 (2)移除export语句，解决模型下拉菜单为空问题。请重新加载扩展验证。",
      "dependencies": [
        "T-20251223-act-017-build-manifest",
        "T-20251223-act-018-build-icons"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 3,
      "interfaces_touched": [
        "all"
      ],
      "artifacts": [
        "docs/e2e-validation-report.md",
        "scripts/build.js",
        "manifest.json",
        "Compact/Compact-T-20251223-act-019-e2e-validation-2025-12-24-T232928Z.md"
      ],
      "citations": [],
      "created_at": "2025-12-24T22:00:00Z",
      "updated_at": "2025-12-24T23:29:28Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-019",
        "validation",
        "e2e",
        "mvp-critical"
      ]
    },
    "T-20251223-act-020-chrome-store-prep": {
      "execution_order": 20,
      "execution_layer": 9,
      "parallel_with": [],
      "seed_id": "ACT-020",
      "title": "Chrome Web Store 发布准备",
      "type": "doc",
      "summary": "准备 Chrome Web Store 发布所需材料，包括商店描述、截图、分类选择等。",
      "acceptance_draft": [
        "撰写商店描述（短描述 + 详细描述）",
        "准备 1-5 张功能截图（1280x800 或 640x400）",
        "准备宣传图片（440x280 小型, 920x680 大型 marquee 可选）",
        "确认分类 (Productivity / Education)",
        "确认隐私政策 URL 可访问",
        "打包扩展为 .zip 文件",
        "创建 Chrome 开发者账号（如尚未有）"
      ],
      "lane": "later",
      "priority_suggested": "P2",
      "status": "completed",
      "status_note": "已完成：创建了 docs/store-listing.md（含商店描述、截图清单、宣传图说明）、screenshots/ 目录、udemy-subtitle-enhancement.zip 打包文件。隐私政策 URL 已验证可访问。截图和宣传图需用户手动制作。",
      "dependencies": [
        "T-20251223-act-019-e2e-validation",
        "T-20251223-act-014-doc-privacy-policy"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "docs",
        "chrome-store"
      ],
      "artifacts": [
        "docs/store-listing.md",
        "screenshots/",
        "udemy-subtitle-enhancement.zip"
      ],
      "citations": [
        "EVID-011"
      ],
      "created_at": "2025-12-24T22:00:00Z",
      "updated_at": "2025-12-25T07:40:00Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-020",
        "doc",
        "chrome-store",
        "release"
      ]
    },
    "T-20251225-act-021-custom-api-base": {
      "execution_order": 21,
      "execution_layer": 10,
      "parallel_with": [],
      "seed_id": "ACT-021",
      "title": "支持自定义 API Base URL",
      "type": "feature",
      "summary": "添加自定义 API 端点支持，允许用户使用第三方 OpenAI/Gemini 兼容服务（如 ohmygpt、one-api 等代理服务）。",
      "acceptance_draft": [
        "用户可在设置中填写自定义 OpenAI Base URL",
        "用户可在设置中填写自定义 Gemini Base URL",
        "留空时使用官方默认端点（向后兼容）",
        "使用自定义端点时跳过 API Key 格式验证（sk- 前缀检查）",
        "验证时调用自定义端点的 /models 接口确认连通性",
        "翻译功能正常使用自定义端点",
        "使用自定义端点时自动申请该域名 Host 权限（无需手动改 manifest）"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "已完成：修改 types/index.ts、settings-manager.ts、openai-client.ts、gemini-client.ts、translator.ts、popup.html/css/ts，添加可折叠的自定义端点设置区域，支持 OpenAI 和 Gemini 双端点配置。Code Review P1 修复：在 service-worker.ts 和 preloader.ts 中添加 baseUrl 参数传递，确保自定义端点配置生效。补充修复：为避免 MV3 host_permissions 限制导致自定义端点请求 Failed to fetch，在 manifest 中加入官方端点 host_permissions + optional_host_permissions，并在 Popup「保存并验证」时自动请求目标域名 Host 权限；移除无效的 permissions 权限声明（Chrome 提示 unknown）。",
      "dependencies": [
        "T-20251223-act-020-chrome-store-prep"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 4,
      "interfaces_touched": [
        "types",
        "storage",
        "openai-client",
        "gemini-client",
        "translator",
        "popup-ui",
        "service-worker",
        "preloader",
        "manifest"
      ],
      "artifacts": [
        "src/types/index.ts",
        "src/storage/settings-manager.ts",
        "src/services/openai-client.ts",
        "src/services/gemini-client.ts",
        "src/services/translator.ts",
        "src/popup/popup.html",
        "src/popup/popup.css",
        "src/popup/popup.ts",
        "src/background/service-worker.ts",
        "src/services/preloader.ts",
        "manifest.json",
        "Compact/Compact-T-20251225-act-021-custom-api-base-2025-12-25-T130500Z.md"
      ],
      "citations": [],
      "created_at": "2025-12-25T12:00:00Z",
      "updated_at": "2025-12-25T22:03:06Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-021",
        "feature",
        "api",
        "third-party-support"
      ]
    },
    "T-20251231-act-022-cache-match-fix": {
      "execution_order": 22,
      "execution_layer": 10,
      "parallel_with": [],
      "seed_id": "ACT-022",
      "title": "修复缓存匹配：移除内容哈希检查，改用 courseId + lectureId 匹配",
      "type": "fix",
      "summary": "解决重新打开网页时因 Udemy 自动字幕内容微小变化导致的误触发重新翻译问题。Udemy 自动生成的字幕每次加载可能产生不同的 cue 数量或时间戳，导致内容哈希变化，被误判为字幕已更新。改用稳定的 courseId + lectureId 作为缓存匹配的唯一标识。",
      "acceptance_draft": [
        "重新打开已翻译课程页面时直接使用缓存，不触发重新翻译",
        "用户手动点击重新翻译仍可正常工作",
        "缓存键仍为 courseId-lectureId，存储结构无变化"
      ],
      "lane": "now",
      "priority_suggested": "P1",
      "status": "completed",
      "status_note": "已移除内容哈希检查逻辑，缓存决策仅基于 courseId + lectureId。Code Review 修复：恢复 originalVtt/originalHash 接口兼容性，hash 仅用于存储不用于比较。",
      "dependencies": [
        "T-20251223-act-010-build-local-cache",
        "T-20251223-act-012-build-retranslate"
      ],
      "blocked": false,
      "blocked_by": [],
      "unblock_plan": "",
      "estimate_h": 1,
      "interfaces_touched": [
        "service-worker",
        "version-checker",
        "preloader"
      ],
      "artifacts": [
        "src/services/version-checker.ts",
        "src/background/service-worker.ts",
        "src/services/preloader.ts",
        "src/services/__tests__/version-checker.test.ts",
        "Compact/Compact-T-20251231-act-022-cache-match-fix-2025-12-31-T215018Z.md"
      ],
      "citations": [],
      "created_at": "2025-12-31T00:00:00Z",
      "updated_at": "2025-12-31T22:30:00Z",
      "completed_at": "2025-12-31T21:50:18Z",
      "owner": "claude-code",
      "tags": [
        "seed:ACT-022",
        "bugfix",
        "cache",
        "ux-improvement"
      ],
      "completion_summary": {
        "deliverables": [
          "src/services/version-checker.ts",
          "src/background/service-worker.ts",
          "src/services/preloader.ts",
          "src/services/__tests__/version-checker.test.ts",
          "Compact/Compact-T-20251231-act-022-cache-match-fix-2025-12-31-T215018Z.md"
        ],
        "key_findings": [
          "Udemy 自动字幕每次加载可能产生不同的 cue 数量或时间戳",
          "内容哈希比较导致不必要的重新翻译",
          "courseId + lectureId 作为唯一标识足够稳定"
        ],
        "changes_made": [
          "缓存决策仅基于 courseId + lectureId，不再比较 hash",
          "保留 originalVtt 参数和 originalHash 返回值用于存储（不用于缓存决策）",
          "service-worker.ts 不再计算哈希用于版本检查",
          "preloader.ts 添加 originalHash fallback 处理",
          "更新 version-checker 测试用例"
        ]
      },
      "code_review_fixes": [
        {
          "finding": "[P1] Version checker signature now rejects callers with originalVtt",
          "fix": "恢复 originalVtt/originalHash 接口兼容性，hash 仅计算用于存储，不用于缓存决策",
          "files_changed": [
            "src/services/version-checker.ts",
            "src/services/preloader.ts",
            "src/services/__tests__/version-checker.test.ts"
          ],
          "verified": true
        }
      ]
    }
  },
  "questions_for_human": [
    {
      "id": "Q-01",
      "question": "Udemy 播放器是否允许动态添加 <track> 元素？需 Spike 验证后确认技术路径。",
      "answer": "是，已验证通过。Data URI、Blob URL、addTextTrack API 三种方案均可行，无 CSP 拦截。推荐使用 Data URI 方案。",
      "status": "resolved",
      "resolved_date": "2025-12-23"
    },
    {
      "id": "Q-03",
      "question": "是否需要支持双语字幕同时显示模式？当前 MVP 规划中未包含，如需要请明确优先级。",
      "answer": "否",
      "status": "resolved"
    },
    {
      "id": "Q-05",
      "question": "是否需要支持用户自定义术语表？项目简介提及为未来规划，确认 MVP 不含。",
      "answer": "否，只会给 LLM 提供课程名字",
      "status": "resolved"
    },
    {
      "id": "Q-06",
      "question": "是否需要扩展到其他浏览器（Edge/Firefox）？当前仅规划 Chrome 扩展。",
      "answer": "只规划 Chrome",
      "status": "resolved"
    },
    {
      "id": "Q-07",
      "question": "项目简介中提到 GPT-5.1/Gemini 3Pro 等模型，但研究证据基于 GPT-4，需确认目标模型列表及对应 API 接口。",
      "answer": "先以 GPT-5.1/Gemini 3Pro 等模型作为标准，需要去验证是否有变化",
      "status": "pending_verification"
    }
  ],
  "assumptions": [
    "用户拥有有效的 OpenAI 或 Google Gemini API Key 并愿意承担翻译费用",
    "Udemy 网站短期内不会大幅重构播放器导致扩展完全失效",
    "用户主要观看有英文字幕的课程（无原文字幕暂不支持）",
    "[已验证] Chrome Manifest V3 的 Service Worker 生命周期限制可通过流式 API + Chrome API 保活规避 - 2025-12-23 研究验证",
    "[已验证] data URI 或 Blob URL 方式可绕过 Udemy 页面 CSP - 2025-12-23 实测通过"
  ],
  "risks": [
    {
      "id": "R-20251223-udemy-dom-change",
      "summary": "Udemy 更新播放器导致字幕注入失效",
      "severity": "high",
      "mitigation": "抽象 DOM 选择器层便于快速修复；建立 E2E 测试监控；建立用户反馈通道",
      "citations": [
        "EVID-008"
      ]
    },
    {
      "id": "R-20251223-llm-latency",
      "summary": "LLM 翻译延迟过长（>30s）影响体验",
      "severity": "mid",
      "mitigation": "预加载机制覆盖 90% 场景；提供手动取消/重试；可选快速模式（传统 MT）",
      "citations": [
        "EVID-009"
      ]
    },
    {
      "id": "R-20251223-api-cost",
      "summary": "API 费用超出用户预期",
      "severity": "mid",
      "mitigation": "设置面板显示字数/费用估算；推荐 Gemini 免费额度；提供低成本模型降级选项",
      "citations": [
        "EVID-010",
        "EVID-005"
      ]
    },
    {
      "id": "R-20251223-store-rejection",
      "summary": "Chrome Web Store 审核拒绝（权限过多/隐私问题）",
      "severity": "high",
      "mitigation": "最小权限原则；提供清晰隐私政策；必要时仅发布 .crx 侧载版",
      "citations": [
        "EVID-011"
      ]
    },
    {
      "id": "R-20251223-llm-output-format",
      "summary": "LLM 输出格式不可靠（时间戳错乱、内容审查拒绝）",
      "severity": "mid",
      "mitigation": "Prompt 明确要求保持时间标签不变；校验返回结果格式；格式错误时自动修正或重试",
      "citations": [
        "EVID-004"
      ]
    },
    {
      "id": "R-20251223-api-key-security",
      "summary": "用户 API Key 安全风险",
      "severity": "mid",
      "mitigation": "Key 仅存 Chrome 扩展私有存储区；内容脚本不直接接触 Key；指导用户定期更换",
      "citations": [
        "EVID-007"
      ]
    }
  ],
  "external_dependencies": [
    {
      "dep_id": "DEP-001",
      "name": "OpenAI GPT API",
      "type": "api",
      "status": "approved",
      "doc_url": "https://platform.openai.com/docs/api-reference",
      "note": "用户自备 API Key，扩展仅作调用中介",
      "citations": [
        "EVID-009",
        "EVID-010"
      ]
    },
    {
      "dep_id": "DEP-002",
      "name": "Google Gemini API",
      "type": "api",
      "status": "approved",
      "doc_url": "https://ai.google.dev/docs",
      "note": "用户自备 API Key，有免费额度可用",
      "citations": [
        "EVID-005"
      ]
    },
    {
      "dep_id": "DEP-003",
      "name": "Udemy Web 前端 (Video.js)",
      "type": "access",
      "status": "verified",
      "doc_url": "",
      "note": "已验证 (2025-12-23): 当前 Udemy 页面允许动态添加 <track> 元素，Data URI/Blob URL/addTextTrack 均可用，无 CSP 拦截。需持续监控播放器更新。",
      "citations": [
        "EVID-008"
      ]
    },
    {
      "dep_id": "DEP-004",
      "name": "Chrome Web Store 审核",
      "type": "policy",
      "status": "unknown",
      "doc_url": "https://developer.chrome.com/docs/webstore/program-policies",
      "note": "权限声明或隐私政策可能不符合要求；备选 .crx 侧载分发",
      "citations": [
        "EVID-011"
      ]
    },
    {
      "dep_id": "DEP-005",
      "name": "Chrome Manifest V3 API",
      "type": "lib",
      "status": "approved",
      "doc_url": "https://developer.chrome.com/docs/extensions/mv3/",
      "note": "参照官方文档开发，注意 Service Worker 生命周期限制",
      "citations": [
        "EVID-011"
      ]
    },
    {
      "dep_id": "DEP-006",
      "name": "CSP 绕过方案（data URI / chrome.runtime.getURL）",
      "type": "lib",
      "status": "approved",
      "doc_url": "",
      "note": "已有成熟方案，需在 Spike 中实际验证当前环境有效性",
      "citations": [
        "EVID-006"
      ]
    }
  ],
  "facts": [
    "Udemy 使用 Video.js 播放器，字幕格式为 WebVTT [EVID-008]",
    "LLM 翻译（GPT-4）成本约 $18/百万字符，速度较传统 MT 慢 15-20 倍 [EVID-009]",
    "Google Gemini 提供免费 API 额度可降低用户入门门槛 [EVID-005]",
    "Chrome Manifest V3 要求使用 Service Worker 替代持久后台页，存在生命周期限制 [EVID-011]",
    "原生 <track> 元素注入可复用播放器样式控制逻辑，确保字幕外观一致 [EVID-006][EVID-008]"
  ],
  "decisions": [
    {
      "id": "D-20251223-track-inject",
      "summary": "字幕注入方式选择原生 <track> 元素而非 DOM Overlay",
      "rationale": "确保样式继承与全屏兼容，复用 Udemy Video.js 播放器的字号、位置、背景控制逻辑",
      "citations": [
        "EVID-008",
        "EVID-006"
      ],
      "date": "2025-12-23T12:00:00Z"
    },
    {
      "id": "D-20251223-multi-engine",
      "summary": "翻译模型由用户自选（OpenAI GPT / Google Gemini），扩展不绑定单一供应商",
      "rationale": "给用户灵活性以比较翻译效果和控制成本；Gemini 免费额度降低入门门槛",
      "citations": [
        "EVID-001",
        "EVID-005"
      ],
      "date": "2025-12-23T12:00:00Z"
    },
    {
      "id": "D-20251223-local-only-cache",
      "summary": "字幕缓存仅存本地（chrome.storage.local 或 IndexedDB），不上传云端",
      "rationale": "降低合规与隐私风险；用户数据不离开本机",
      "citations": [
        "EVID-007"
      ],
      "date": "2025-12-23T12:00:00Z"
    },
    {
      "id": "D-20251223-llm-translation",
      "summary": "采用 LLM 在线翻译方案（方案 A），放弃传统 MT 逐句翻译",
      "rationale": "LLM 可利用整段上下文产出连贯译文，真正解决断句割裂问题，决策矩阵综合得分 A=4.2 > B=3.9",
      "citations": [
        "EVID-001",
        "EVID-004"
      ],
      "date": "2025-12-23T12:00:00Z"
    }
  ]
}
